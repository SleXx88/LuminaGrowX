<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lisa Pro - Growbox</title>
    <link rel="stylesheet" href="/pico.min.css" />
    <style>
      :root {
        --accent: #ef4444;
        --accent-2: #dc2626;
        --glass: rgba(20, 20, 22, 0.42);
        --glass-strong: rgba(20, 20, 22, 0.62);
        --muted: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.18);
        --text: #e5e7eb;
        --text-dim: #cbd5e1;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --radius: 18px;
        --pico-background-color: transparent;
        --pico-card-background-color: transparent;
      }
      html,
      body { height: 100%; }
      body {
        position: relative;
        color: var(--text);
        background: transparent;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: #0b0b0c;
        z-index: -1;
      }
      header.hero, article, footer.site, dialog.modal article {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        backdrop-filter: blur(3px);
      }
      article > header {
        background: var(--glass-strong);
        border-bottom: 1px solid var(--border);
        border-radius: var(--radius) var(--radius) 0 0;
        padding: 0.75rem 1rem;
      }
      a, h1, h2, h3, h4, h5 { color: var(--text); }
      .grid { gap: 1rem; }
      .status-grid { display: grid; grid-template-columns: 1fr; }
      header.hero { padding: 1rem; }
      main.container { flex: 1; display: flex; flex-direction: column; }
      header.hero h1.brand {
        font-size: clamp(2.2rem, 6vw, 3.3rem);
        letter-spacing: 0.04em;
        margin: 0.25rem 0 0;
        position: relative;
        display: inline-flex;
        align-items: flex-start;
        gap: 0.25rem;
      }
      .brand-word { color: #ffffff; font-weight: 800; }
      .brand-pro { color: var(--accent); font-weight: 800; font-size: 0.55em; line-height: 1; vertical-align: super; position: relative; top: -0.25em; }
      header.hero p.subtitle { margin: 0.25rem 0 0; opacity: 0.85; color: var(--text-dim); }
      .health-banner { margin-top: 0.6rem; padding: 0.6rem 0.8rem; border-radius: var(--radius); border: 1px solid var(--border); background: rgba(239, 68, 68, 0.12); color: var(--text); }
      .health-banner.ok { display: none; }
      .health-list { margin: 0.25rem 0 0; padding-left: 1rem; }
      .badge {
        display: inline-flex; align-items: center; gap: 0.4rem;
        font-size: 0.85rem; padding: 0.25rem 0.5rem; border-radius: 999px;
        background: var(--glass-strong); border: 1px solid var(--border);
      }
      .badge-accent {
        display: inline-flex; align-items: center; gap: 0.4rem;
        font-size: 0.85rem; padding: 0.25rem 0.55rem; border-radius: 999px;
        background: var(--accent); color: #fff; border: 1px solid var(--accent);
        text-decoration: none;
      }
      /* Firmware-Badges als Stapel: neuer Badge leicht über altem */
      .fw-stack { display: inline-flex; align-items: center; gap: 0.3rem; }
      .dot { width: 0.55rem; height: 0.55rem; border-radius: 50%; background: #9ca3af; display: inline-block; }
      .dot.ok { background: var(--ok); }
      .dot.warn { background: var(--warn); }
      .dot.err { background: var(--err); }
      .icon { display: inline-flex; align-items: center; justify-content: center; line-height: 0; }
      .icon svg { width: 18px; height: 18px; display: block; }
      .icon.ok { color: var(--ok); } .icon.warn { color: var(--warn); } .icon.err { color: var(--err); }
      .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .nav-status { display: flex; flex-direction: column; gap: 0.04rem; align-items: flex-end; }
      .nav-status > li { margin: 0; }
      .nav-status-row { display: flex; gap: 0.3rem; align-items: center; }
      .hidden { display: none !important; }
      input, select, button, [role="button"], .button { border-radius: var(--radius); }
      input, select { background: rgba(255, 255, 255, 0.02); color: var(--text); border: 1px solid var(--border); }
      button, [role="button"], .button { background: rgba(20, 20, 22, 0.42); color: var(--text); border: 1px solid var(--border); font-weight: 700; font-size: 1rem; line-height: 1.2; padding: 0.55rem 0.9rem; border-radius: var(--radius) !important; }
      /* Desktop/Laptop: etwas kompaktere Buttons */
      @media (min-width: 768px) {
        button, [role="button"], .button { font-size: 0.95rem; padding: 0.5rem 0.85rem; }
      }
      @media (min-width: 1200px) {
        button, [role="button"], .button { font-size: 0.9rem; padding: 0.45rem 0.8rem; }
      }
      button:hover { background: rgba(255, 255, 255, 0.06); }
      button:active, button.primary, .primary { background: var(--accent) !important; color: #fff !important; border-color: var(--accent) !important; }
      input[type="checkbox"], input[type="radio"] { accent-color: var(--accent); }
      input[type="checkbox"] { width: 1.1rem; height: 1.1rem; margin-right: 0.5rem; border: 2px solid var(--border); background: rgba(255, 255, 255, 0.06); cursor: pointer; vertical-align: middle; position: relative; }
      input[type="checkbox"]:checked { background-color: var(--accent); border-color: var(--accent); }
      label { cursor: pointer; display: inline-flex; align-items: center; margin-bottom: 0.25rem; }
      label > input[type="checkbox"] { margin-bottom: 0; }
      footer.site { padding: 0.9rem 1.1rem; }
      .grow-title { font-size: clamp(1.4rem, 3.5vw, 2rem); margin: 0; }
      .grow-meta { display: flex; gap: 1rem; flex-wrap: wrap; color: var(--text-dim); }
      .progress { height: 10px; background: rgba(255, 255, 255, 0.12); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
      .progress > span { display: block; height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

      /* Desktop-Optimierung: Spezielles Spalten-Layout */
      @media (min-width: 1024px) {
        main.container {
          max-width: 98% !important;
          width: 98% !important;
          margin: 1rem auto !important;
        }
        html { font-size: 15px; }
        header.hero h1.brand { font-size: 2.2rem !important; }
        
        .grid {
          display: grid !important;
          grid-template-columns: 1fr 1fr !important;
          grid-template-areas: 
            "grow live"
            "dry live"
            "footer live" !important;
          align-items: start;
          gap: 1rem !important;
        }
        #artGrow { grid-area: grow; }
        #artDry { grid-area: dry; }
        #artLive { grid-area: live; }
        #mainFooter { grid-area: footer; }

        button, [role="button"], .button { 
          font-size: 0.85rem !important; 
          padding: 0.4rem 0.8rem !important; 
        }
        .badge { font-size: 0.75rem !important; padding: 0.2rem 0.5rem !important; }
      }

      /* Einklapp-Stile */
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .collapse-icon {
        transition: transform 0.3s;
      }
      .collapsed .collapse-icon {
        transform: rotate(-90deg);
      }
      .collapsed .card-content {
        display: none !important;
      }

      /* Profi-Modus Optimierungen */
      .mode-settings-block {
        background: rgba(255, 255, 255, 0.03);
        padding: 0.75rem;
        border-radius: 12px;
        border: 1px solid var(--border);
      }
      .mode-label {
        display: block;
        margin-bottom: 0.75rem;
        color: var(--accent);
        font-size: 0.85rem;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.05em;
      }
      .mode-inputs-list {
        display: grid;
        gap: 0.4rem;
      }
      .input-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(0,0,0,0.15);
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
      }
      .input-row label {
        flex: 1;
        margin: 0;
        font-size: 0.8rem;
        color: var(--text-dim);
      }
      .input-row input {
        width: 65px !important;
        margin: 0 !important;
        padding: 0.2rem 0.4rem !important;
        text-align: center;
        height: auto !important;
        font-size: 0.85rem !important;
      }
      .input-row .unit {
        font-size: 0.7rem;
        color: var(--text-dim);
        width: 25px;
        text-align: left;
      }
      .input-row input[type="checkbox"] {
        width: 1.2rem !important;
        height: 1.2rem !important;
        margin: 0 !important;
      }

      @media (min-width: 1024px) {
        #modesGrid {
          display: grid !important;
          grid-template-columns: repeat(2, 1fr) !important;
          gap: 0.75rem !important;
        }
      }
    </style>
  </head>
  <body>
    <main class="container" style="margin-top: 1rem; flex: 1; display: flex; flex-direction: column; gap: 1rem;">
      <header class="hero" style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 1.5rem 1rem; position: relative;">
        <div class="brand-area">
          <h1 class="brand" style="margin: 0;"><span class="brand-word">LISA</span><span class="brand-pro">PRO</span></h1>
          <p class="subtitle" style="margin: 0;">Automatisierte Growbox</p>
        </div>
        
        <ul class="nav-status" style="display: flex; flex-direction: row; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; list-style: none; padding: 0; margin: 1rem 0 0; width: 100%;">
          <li class="nav-status-row" style="margin: 0;">
            <span class="badge" title="Internetverbindung"><span id="liveIcon" class="icon"></span></span>
            <span class="badge" title="Benachrichtigungen"><span id="waIcon" class="icon"></span></span>
            <span class="badge" title="MQTT Status"><span id="mqttIcon" class="icon"></span></span>
            <span class="fw-stack" title="Firmware">
              <span class="badge fw-old"><span id="fwTop" class="mono">-</span></span>
              <a id="fwTopUpd" class="badge-accent fw-new" href="/update" style="display:none"></a>
            </span>
          </li>
          <li class="nav-status-row" style="margin: 0;">
            <span class="badge" title="Datum/Uhrzeit"><span id="ntpTop" class="mono">--</span></span>
          </li>
        </ul>
        <div id="healthBanner" class="health-banner ok" style="width: 100%; margin-top: 1rem;"></div>
      </header>

      <div class="grid" style="margin-top: 0">
        <article id="artGrow">
          <header class="card-header" onclick="toggleCard('artGrow')">
            <h2>Grow</h2>
            <span class="collapse-icon"><svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
          </header>
          <div class="card-content" style="padding: 1rem; display: grid; gap: 0.8rem">
            <h3 id="growTitle" class="grow-title">Noch nicht gestartet</h3>
            <div class="grow-meta">
              <span>Gesamt: <strong><span id="totalDays">90</span> Tage</strong></span>
              <span>Start: <strong><span id="growStart">-</span></strong></span>
            </div>
            <div class="progress"><span id="growProgress"></span></div>
            <div style="display: grid; gap: 0.5rem;">
              <div id="seedInputContainer">
                <label style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.25rem;">Sorte / Strain Name</label>
                <input type="text" id="seedInp" placeholder="z.B. Northern Lights" style="margin: 0; padding: 0.4rem 0.6rem; height: auto;">
              </div>
              <button id="toggleGrow" type="button">START</button>
              
              <div id="startOptions">
                <small style="color: var(--text-dim); font-size: 0.75rem; display: block; margin-top: 0.2rem; margin-bottom: 0.4rem;">
                  Falls die Pflanzen bereits älter sind, gib hier den aktuellen Tag an.
                </small>
                <div id="startDayContainer" style="display: flex; align-items: center; gap: 0.5rem;">
                  <small style="white-space: nowrap;">Start-Tag:</small>
                  <input type="number" id="growStartDayInp" value="1" min="1" max="200" style="width: 80px; margin: 0; padding: 0.3rem 0.5rem; height: auto;">
                </div>
              </div>
            </div>

            <details id="growEdit" class="hidden" style="margin-top: 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem 1rem;">
              <summary style="font-weight: 600; cursor: pointer;">Alter korrigieren</summary>
              <div style="margin-top: 1rem; display: grid; gap: 0.5rem;">
                <small style="color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.2rem; display: block;">
                  Falls die Pflanzen bereits älter sind, gib hier den aktuellen Tag an.
                </small>
                <label style="font-size: 0.8rem; color: var(--text-dim);">Aktueller Tag:</label>
                <div style="display: flex; gap: 0.5rem;">
                  <input type="number" id="growCurrentDayInp" min="1" max="200" style="margin:0; padding: 0.3rem 0.5rem; height: auto;">
                  <button class="outline" style="padding: 0.3rem 0.8rem;" onclick="setGrowDay()">Set</button>
                </div>
                <small style="color: var(--text-dim); font-size: 0.7rem; display: block;">
                  Verschiebt den Zeitplan, falls die Pflanzen schneller oder langsamer wachsen als geplant.
                </small>
              </div>
            </details>
            
            <details id="detailsDoorActions" style="margin-top: 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem 1rem;">
              <summary style="font-weight: 600; cursor: pointer;">Maßnahmen wenn Tür geöffnet wird</summary>
              <div style="margin-top: 1rem; display: grid; gap: 0.75rem;">
                <label><input type="checkbox" id="doorPauseControl"> Regelung pausieren wenn Tür offen</label>
                <label><input type="checkbox" id="doorLightOn"> Beleuchtung EIN (Arbeitslicht 10%)</label>
                <label><input type="checkbox" id="doorPumpOff"> Pumpe AUS</label>
                <label><input type="checkbox" id="doorLiftPanel"> LED-Panel anheben (10cm)</label>
                
                <div style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
                  <button id="btnDoorActionsSave" class="primary">Maßnahmen speichern</button>
                </div>
              </div>
            </details>

            <details id="detailsSilent" style="margin-top: 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem 1rem;">
              <summary style="font-weight: 600; cursor: pointer;">Silent-Modus (Nachts leiser)</summary>
              <div style="margin-top: 1rem; display: grid; gap: 1rem;">
                <label><input type="checkbox" id="silentEnabled" role="switch"> Silent-Modus aktivieren</label>
                
                <div id="silentContent" class="hidden">
                  <div style="display: grid; gap: 0.75rem;">
                    <div class="mode-settings-block">
                      <strong class="mode-label">Zeitplan (Silent)</strong>
                      <div class="mode-inputs-list">
                        <div class="input-row"><label>Startzeit</label><input type="time" id="silentStart" style="width: 100px !important;"></div>
                        <div class="input-row"><label>Endzeit</label><input type="time" id="silentEnd" style="width: 100px !important;"></div>
                      </div>
                    </div>

                    <div class="mode-settings-block">
                      <strong class="mode-label">Lüfter-Limits (Silent)</strong>
                      <div class="mode-inputs-list">
                        <div class="input-row"><label>Abluft-Lüfter (1 & 2)</label>
                          <input type="number" id="silentFExhMin" placeholder="Min" min="0" max="100">
                          <input type="number" id="silentFExhMax" placeholder="Max" min="0" max="100">
                          <span class="unit">%</span>
                        </div>
                        <div class="input-row"><label>Umluft-Lüfter (LED)</label>
                          <input type="number" id="silentFCircMin" placeholder="Min" min="0" max="100">
                          <input type="number" id="silentFCircMax" placeholder="Max" min="0" max="100">
                          <span class="unit">%</span>
                        </div>
                      </div>
                    </div>

                    <div class="mode-settings-block">
                      <strong class="mode-label">Optionen (Silent)</strong>
                      <div class="mode-inputs-list">
                        <div class="input-row">
                          <label>Pumpe (Luft) während Silent-Phase erlaubt</label>
                          <input type="checkbox" id="silentPump">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div style="display: flex; justify-content: flex-end;">
                  <button id="btnSilentSaveMain" class="primary">Silent-Modus speichern</button>
                </div>
              </div>
            </details>

            <details style="margin-top: 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem 1rem;">
              <summary style="font-weight: 600; cursor: pointer;">Phasen-Konfiguration</summary>
              <div style="margin-top: 1rem; display: grid; gap: 1rem;">
                <label>Phase wählen
                  <select id="phaseSel">
                    <option value="0">Keimling (Seedling)</option>
                    <option value="1">Wachstum (Veg)</option>
                    <option value="2">Blüte (Flowering)</option>
                  </select>
                </label>

                <div style="display: grid; gap: 0.75rem;">
                  <div class="mode-settings-block">
                    <strong class="mode-label">Licht-Zeitplan</strong>
                    <div class="mode-inputs-list">
                      <div class="input-row"><label>Licht AN</label><input type="time" id="phOn" style="width: 100px !important;"></div>
                      <div class="input-row"><label>Licht AUS</label><input type="time" id="phOff" style="width: 100px !important;"></div>
                    </div>
                  </div>

                  <div class="mode-settings-block">
                    <strong class="mode-label">Umluft-Lüfter (LED)</strong>
                    <div class="mode-inputs-list">
                      <div class="input-row">
                        <label>Leistung (Min / Max)</label>
                        <input type="number" id="phFCircMin" placeholder="Min" min="0" max="100">
                        <input type="number" id="phFCircMax" placeholder="Max" min="0" max="100">
                        <span class="unit">%</span>
                      </div>
                    </div>
                  </div>

                  <div class="mode-settings-block">
                    <strong class="mode-label">Optionen</strong>
                    <div class="mode-inputs-list">
                      <div class="input-row">
                        <label>Pumpe (Luft) für diese Phase aktiviert</label>
                        <input type="checkbox" id="phPump">
                      </div>
                    </div>
                  </div>
                </div>

                <div style="margin-top:0.5rem">
                  <label><input type="checkbox" id="toggleProfi" role="switch"> Profi-Modus</label>
                </div>

                <div id="profiBlock" class="hidden" style="border-left: 2px solid var(--accent); padding-left: 1rem; margin-left: 0.2rem;">
                  <div class="mode-settings-block" style="margin-bottom: 0.75rem;">
                    <strong class="mode-label">Sonnen-Simulation</strong>
                    <div class="mode-inputs-list">
                      <div class="input-row"><label>Sonnenaufgang</label><input type="number" id="phRise" min="0"><span class="unit">min</span></div>
                      <div class="input-row"><label>Sonnenuntergang</label><input type="number" id="phSet" min="0"><span class="unit">min</span></div>
                    </div>
                  </div>
                  <h5 style="margin-top:1rem">Werte je Tageszeit</h5>
                  <div id="modesGrid" style="display:grid; gap:1rem;"></div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                  <button id="btnResetPhases" class="outline secondary">Werkseinstellungen</button>
                  <button id="btnSavePhases" class="primary">Speichern</button>
                </div>
              </div>
            </details>
          </div>
        </article>

        <article id="artDry">
          <header class="card-header" onclick="toggleCard('artDry')">
            <h2>Trocknung</h2>
            <span class="collapse-icon"><svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
          </header>
          <div class="card-content" style="padding: 1rem; display: grid; gap: 0.8rem">
            <h3 id="dryTitle" class="grow-title">Nicht aktiv</h3>
            <div class="grow-meta">
              <span>Dauer: <strong>14 Tage</strong></span>
              <span>Start: <strong><span id="dryStart">-</span></strong></span>
            </div>
            <div class="progress"><span id="dryProgress"></span></div>
            <p style="font-size: 0.9rem; color: var(--text-dim); margin: 0;">
              <strong>Bedingungen:</strong> 45-55% RH, LED aus, min. 20% Lüfter für Luftaustausch
            </p>
            <div style="display: flex; gap: 0.5rem">
              <button id="toggleDry" type="button">TROCKNUNG STARTEN</button>
            </div>
          </div>
        </article>

        <article id="artLive">
          <header><h2>Live Status</h2></header>
          <div class="content" style="padding: 0.75rem; display: grid; gap: 0.75rem;">
            
            <!-- KLIMA INNEN -->
            <div style="padding: 0.5rem; background: rgba(239, 68, 68, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--accent); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="display: inline-flex; width: 0.9rem; height: 0.9rem; color: var(--accent);" id="iconKlimaIn"></span>
                <span>Klima Growbox</span>
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Temperatur</div>
                  <div style="font-size: 1.1rem; font-weight: 700;" class="mono"><span id="stT">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">°C</small></div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Luftfeuchte</div>
                  <div style="font-size: 1.1rem; font-weight: 700;" class="mono"><span id="stH">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">%</small></div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">VPD</div>
                  <div style="font-size: 1.1rem; font-weight: 700;" class="mono"><span id="stVpd">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">kPa</small></div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Taupunkt</div>
                  <div style="font-size: 1.1rem; font-weight: 700;" class="mono"><span id="stDew">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">°C</small></div>
                </div>
              </div>
            </div>

            <!-- AKTOREN -->
            <div style="padding: 0.5rem; background: rgba(34, 197, 94, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--ok); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="display: inline-flex; width: 0.9rem; height: 0.9rem; color: var(--ok);" id="iconAktoren"></span>
                <span>Aktoren & Status</span>
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotLight"></span>
                    <div style="font-size: 0.65rem; color: var(--text-dim);">LED (Beleuchtung)</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700;" class="mono" id="stLightPct">-</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotFan"></span>
                    <div style="font-size: 0.65rem; color: var(--text-dim);">Abluft (Lüfter)</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700;" class="mono" id="stFanPct">-</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotFan3"></span>
                    <div style="font-size: 0.65rem; color: var(--text-dim);">Umluft (LED)</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700;" class="mono" id="stFan3Pct">-</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotSilent"></span>
                    <div style="font-size: 0.65rem; color: var(--text-dim);">Silent-Modus</div>
                  </div>
                  <div style="font-size: 0.9rem; font-weight: 700;" class="mono" id="stSilentState">AUS</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotPump"></span>
                    <div style="font-size: 0.65rem; color: var(--text-dim);">Pumpe (Luft)</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700;" class="mono" id="stPumpState">AUS</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotDoor"></span>
                    <div style="font-size: 0.65rem; color: var(--text-dim);">Tür-Status</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700;" class="mono" id="stDoor">-</div>
                </div>
              </div>
            </div>

            <!-- RAUMKLIMA -->
            <div style="padding: 0.5rem; background: rgba(59, 130, 246, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: #60a5fa; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="display: inline-flex; width: 0.9rem; height: 0.9rem; color: #60a5fa;" id="iconRaum"></span>
                <span>Raumklima (Außen)</span>
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Temperatur</div>
                  <div style="font-size: 1.1rem; font-weight: 700;" class="mono"><span id="stTOut">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">°C</small></div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Luftfeuchte</div>
                  <div style="font-size: 1.1rem; font-weight: 700;" class="mono"><span id="stHOut">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">%</small></div>
                </div>
              </div>
            </div>

            <!-- SYSTEM -->
            <div style="padding: 0.5rem; background: rgba(156, 163, 175, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: #9ca3af; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="display: inline-flex; width: 0.9rem; height: 0.9rem; color: #9ca3af;" id="iconSystem"></span>
                <span>System</span>
              </div>
              <div style="display: grid; gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Uptime</div>
                  <div style="font-size: 1rem; font-weight: 600;" class="mono" id="stUp">-</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                  <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                    <div style="font-size: 0.65rem; color: var(--text-dim);">IP-Adresse</div>
                    <div style="font-size: 0.9rem; font-weight: 600;" class="mono" id="stIp">-</div>
                  </div>
                  <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                    <div style="font-size: 0.65rem; color: var(--text-dim);">Signal (RSSI)</div>
                    <div style="font-size: 0.9rem; font-weight: 600;" class="mono"><span id="stRssi">-</span> <small style="font-size: 0.65rem; font-weight: normal; color: var(--text-dim);">dBm</small></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </article>

        <div id="mainFooter" style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="display: flex; gap: 0.5rem; padding: 0;">
            <a href="/settings" class="button" role="button">Einstellungen</a>
            <a href="/info" class="button" role="button">Info</a>
            <a href="/update" class="button" role="button">Update</a>
          </div>

          <footer class="site" style="padding: 0.9rem 1.1rem; background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); backdrop-filter: blur(3px);">
            <small style="display:block">&copy; 2025 Martin Teske – Alle Rechte vorbehalten.</small>
            <small style="display:block">
              <strong>LuminaGrowX</strong> ist eine Open-Source-Software von 
              <a href="https://martinteske-blog.de" target="_blank">MartinTeske-Blog.de</a>, 
              entwickelt für die <strong>LisaPro Growbox</strong>.
              <br>
              Die LisaPro Growbox ist exklusiv erhältlich bei 
              <a href="https://mutualgarden.de" target="_blank">MutualGarden.de</a>.
            </small>
            <small style="display:block"><span id="apInfo" class="mono"></span></small>
          </footer>
        </div>
      </div> <!-- Ende von Grid Area wrapper -->
    </main>

    <dialog id="dlgNet" class="modal">
      <article>
        <header>
          <h3>Einstellungen</h3>
          <button aria-label="Schließen" rel="prev" onclick="document.getElementById('dlgNet').close()"></button>
        </header>
        <div class="content" style="padding: 1rem; display: grid; gap: 1rem">
          <form id="netForm">
            <h4>WLAN</h4>
            <div class="grid">
              <label>SSID <input id="ssid" name="ssid" placeholder="MeinWiFi" /></label>
              <label>Passwort <input id="pass" name="pass" type="password" placeholder="********" /></label>
            </div>
            <div class="grid">
              <label><input type="checkbox" id="useStatic" name="useStatic" role="switch" /> Statische IP-Adresse verwenden</label>
            </div>
            <div id="staticBlock" class="grid hidden">
              <label>IP-Adresse <input id="ip" name="ip" placeholder="192.168.1.50" /></label>
              <label>Subnetzmaske <input id="mask" name="mask" placeholder="255.255.255.0" /></label>
              <label>Gateway <input id="gw" name="gw" placeholder="192.168.1.1" /></label>
              <label>DNS (optional) <input id="dns" name="dns" placeholder="1.1.1.1" /></label>
            </div>

            <footer style="display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 0.5rem;">
              <button type="button" id="btnNetSave" class="primary">Speichern</button>
            </footer>

            <hr />
            <h4>Benachrichtigungen (WhatsApp via CallMeBot)</h4>
            <label><input type="checkbox" id="notifyEnabled" role="switch" /> Benachrichtigungen aktivieren</label>
            <div id="notifyBlock" class="grid hidden">
              <label>Telefonnummer (+Ländervorwahl) <input id="notifyPhone" placeholder="+49XXXXXXXXXX" /></label>
              <label>API-Key <input id="notifyKey" placeholder="1234567" /></label>
              <div style="display: flex; gap: 0.5rem">
                <button id="btnNotifySave" type="button" class="primary">Speichern</button>
                <button id="btnNotifyTest" type="button">Testnachricht senden</button>
              </div>
            </div>
          </form>
        </div>
        <footer style="display: flex; justify-content: flex-end; padding: 0.75rem 1rem;">
          <button type="button" onclick="document.getElementById('dlgNet').close()">Schließen</button>
        </footer>
      </article>
    </dialog>

    <dialog id="toast" class="modal">
      <article>
        <header><strong>Status</strong></header>
        <div class="content" style="padding: 1rem"><p id="toastMsg">-</p></div>
        <footer style="display: flex; justify-content: flex-end; padding: 0.75rem 1rem;">
          <button onclick="document.getElementById('toast').close()">OK</button>
        </footer>
      </article>
    </dialog>

    <script>
      const $ = (id) => document.getElementById(id);
      // Inline, lizenzfreie SVG-Icons (Check/X/Minus) – Heroicons-ähnlich
      const icons = {
        wifi: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 13a10 10 0 0 1 14 0"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M2 8a15 15 0 0 1 20 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
        mail: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 1 1-7.6-11.7 8.38 8.38 0 0 1 3.8.9L21 3z"/></svg>',
        thermo: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>',
        plant: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M7 20h10"/><path d="M10 20c5.5-2.5 8-6.4 8-10"/><path d="M14 20c-5.5-2.5-8-6.4-8-10"/><path d="M12 20V4"/></svg>',
        home: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        clock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        network: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"/><path d="M12 12V8"/></svg>',
        signal: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 20V4"/></svg>',
        mqtt: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="18" r="3"/><line x1="12" y1="9" x2="12" y2="12"/><line x1="12" y1="12" x2="6" y2="15"/><line x1="12" y1="12" x2="18" y2="15"/></svg>',
        bolt: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
        cpu: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/><path d="M15 2v2"/><path d="M9 2v2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M15 20v2"/><path d="M9 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/></svg>',
      };
      const live = { ws: null, timer: null, lastStatus: null };
      let netDialogOpen = false;
      function showToast(msg) {
        const p = $("toastMsg"); p.textContent = msg; $("toast").showModal();
      }
      function showToastHtml(html) {
        const p = $("toastMsg"); p.innerHTML = html; $("toast").showModal();
      }
      function ipv4ok(s) { const parts = (s || "").split(".").map((n) => +n); return (parts.length === 4 && parts.every((n) => Number.isInteger(n) && n >= 0 && n <= 255)); }
      function phoneOk(s) { return /^\+\d{6,16}$/.test((s || "").trim()); }
      function format1(n) { return n == null || isNaN(n) ? "-" : (+n).toFixed(1); }
      function format0(n) { return n == null || isNaN(n) ? "-" : Math.round(+n).toString(); }
      function formatUptime(sec) {
        if (sec == null || isNaN(sec)) return "-";
        sec = Math.floor(+sec);
        const d = Math.floor(sec / 86400); sec -= d*86400;
        const h = Math.floor(sec / 3600);  sec -= h*3600;
        const m = Math.floor(sec / 60);    const s = sec - m*60;
        if (d > 0) return `${d}d ${h}h ${m}m`;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        return `${m}m ${s}s`;
      }
      function updateToggleButton(started) { $("toggleGrow").textContent = started ? "STOP" : "START"; $("toggleGrow").classList.toggle("primary", started); }
      function updateDryButton(active) { $("toggleDry").textContent = active ? "TROCKNUNG STOPPEN" : "TROCKNUNG STARTEN"; $("toggleDry").classList.toggle("primary", active); }

      function toggleCard(id) {
        $(id).classList.toggle("collapsed");
      }
      function setCardCollapsed(id, collapsed) {
        if (collapsed) $(id).classList.add("collapsed");
        else $(id).classList.remove("collapsed");
      }

      let autoCollapseDone = false;

      function updateStatus(s) {
        live.lastStatus = s;
        
        // Auto-Collapse Logik (nur einmalig nach dem Laden oder bei Statusänderung)
        if (s.grow && s.drying) {
          const growRunning = !!s.grow.started;
          const dryRunning = !!s.drying.active;
          
          if (!autoCollapseDone) {
            if (growRunning) {
              setCardCollapsed("artDry", true);
              setCardCollapsed("artGrow", false);
            } else if (dryRunning) {
              setCardCollapsed("artGrow", true);
              setCardCollapsed("artDry", false);
            } else {
              setCardCollapsed("artGrow", false);
              setCardCollapsed("artDry", false);
            }
            autoCollapseDone = true;
          }
        }
        
        // Internet/WLAN
        const liveEl = $("liveIcon");
        if (liveEl) {
          if (!liveEl.innerHTML) liveEl.innerHTML = icons.wifi;
          liveEl.classList.remove("ok", "warn", "err");
          if (s && s.internet_ok) liveEl.classList.add("ok"); else if (s && s.wifi_connected) liveEl.classList.add("warn"); else liveEl.classList.add("err");
        }
        // Benachrichtigungen
        const waEl = $("waIcon");
        if (waEl) {
          if (!waEl.innerHTML) waEl.innerHTML = icons.mail;
          waEl.classList.remove("ok", "warn", "err");
          const enabled = !!(s && s.notify && s.notify.enabled);
          waEl.classList.add(enabled ? "ok" : "err");
        }
        // MQTT
        const mqttEl = $("mqttIcon");
        if (mqttEl) {
          if (!mqttEl.innerHTML) mqttEl.innerHTML = icons.mqtt;
          mqttEl.classList.remove("ok", "warn", "err");
          if (s && s.mqtt) {
            if (s.mqtt.connected) mqttEl.classList.add("ok");
            else if (s.mqtt.enabled) mqttEl.classList.add("err");
            else mqttEl.classList.add("warn"); // Enabled false = warn (orange/neutral)
          } else {
            mqttEl.classList.add("err");
          }
        }

        if (s.grow) {
          $("growTitle").textContent = s.grow.started ? ("Tag #" + s.grow.day + " - " + (s.grow.phase || "")) : "Noch nicht gestartet";
          if (s.grow.started) {
            $("seedInputContainer").classList.add("hidden");
            if (s.seed) {
              $("growTitle").innerHTML += `<div style="font-size: 0.9rem; opacity: 0.8; font-weight: normal; margin-top: 0.2rem;">Sorte: <strong>${s.seed}</strong></div>`;
            }
          } else {
            $("seedInputContainer").classList.remove("hidden");
          }
          totalDays.textContent = (s.grow.total_days != null ? s.grow.total_days : 90);
          $("growStart").textContent = s.grow.start_epoch ? new Date(s.grow.start_epoch * 1000).toLocaleDateString() : "-";
          
          if (s.grow.started && s.grow.start_epoch) {
            $("growEdit").classList.remove("hidden");
            $("startOptions").classList.add("hidden");
            // Fill day input if not touched
            if (document.activeElement !== $("growCurrentDayInp")) {
              $("growCurrentDayInp").value = s.grow.day;
            }
          } else {
            $("growEdit").classList.add("hidden");
            $("startOptions").classList.remove("hidden");
          }

          const total = s.grow.total_days || 0, day = s.grow.day || 0;
          const pct = total > 0 ? Math.min(100, Math.round((day / total) * 100)) : 0;
          $("growProgress").style.width = pct + "%";
          
          // Button-Zustand Grow Start/Stop / Pausiert
          const toggleBtn = $("toggleGrow");
          const growStarted = !!s.grow.started;
          const controlPaused = !!(s.health && s.health.control_paused);
          
          if (growStarted && controlPaused && s.door_open) {
            toggleBtn.textContent = "Regelung pausiert";
            toggleBtn.classList.remove("primary");
            toggleBtn.style.backgroundColor = "var(--warn)";
            toggleBtn.style.borderColor = "var(--warn)";
            toggleBtn.style.color = "#000";
          } else {
            toggleBtn.textContent = growStarted ? "STOP" : "START";
            toggleBtn.style.backgroundColor = "";
            toggleBtn.style.borderColor = "";
            toggleBtn.style.color = "";
            toggleBtn.classList.toggle("primary", growStarted);
          }
        }
        // Trocknung
        if (s.drying) {
          const dryActive = !!s.drying.active;
          $("dryTitle").textContent = dryActive ? ("Tag " + (s.drying.day || 0) + " von 14") : "Nicht aktiv";
          $("dryStart").textContent = s.drying.start_epoch ? new Date(s.drying.start_epoch * 1000).toLocaleString() : "-";
          const dryDay = s.drying.day || 0;
          const dryPct = Math.min(100, Math.round((dryDay / 14) * 100));
          $("dryProgress").style.width = dryPct + "%";
          updateDryButton(dryActive);
          // Gegenseitige Sperre: Grow-Button disabled wenn Trocknung aktiv
          const growBtn = $("toggleGrow");
          if (growBtn) {
            growBtn.disabled = dryActive;
            if (dryActive) growBtn.title = "Nicht verfügbar während Trocknung";
            else growBtn.title = "";
          }
          // Trocknungs-Button disabled wenn Grow aktiv
          const dryBtn = $("toggleDry");
          if (dryBtn && s.grow) {
            dryBtn.disabled = s.grow.started;
            if (s.grow.started) dryBtn.title = "Nicht verfügbar während Grow";
            else dryBtn.title = "";
          }
        }
        // System/Env/Aktoren
        const up = (typeof s.uptime_s !== 'undefined') ? s.uptime_s : s.uptime;
        $("stUp").textContent = formatUptime(up);
        if ($("stNtp")) $("stNtp").textContent = s.ntp_time || "-";
        const ntpTopEl = document.getElementById("ntpTop"); if (ntpTopEl) ntpTopEl.textContent = s.ntp_time || "--";

        // Umgebung - BOX (Innen)
        $("stT").textContent = format1(s.temp_c);
        $("stH").textContent = format1(s.humi_rh);
        $("stVpd").textContent = format1(s.vpd_kpa);
        if ($("stDew")) $("stDew").textContent = format1(s.dew_c);

        // Umgebung - AUSSEN (Raum)
        if ($("stTOut")) $("stTOut").textContent = format1(s.temp_out_c);
        if ($("stHOut")) $("stHOut").textContent = format1(s.humi_out_rh);

        // Firmware im Hero
        const fwTop = document.getElementById('fwTop'); if (fwTop) fwTop.textContent = (s.fw || '-');
        const fwTopUpd = document.getElementById('fwTopUpd');
        if (fwTopUpd) {
          if (s.update && s.update.has_update && s.update.latest) {
            fwTopUpd.style.display = '';
            fwTopUpd.textContent = 'Neu: ' + s.update.latest;
          } else {
            fwTopUpd.style.display = 'none'; fwTopUpd.textContent = '';
          }
        }

        // Aktoren - LED
        const lightOn = !!s.light_on;
        const lightPct = s.light_pct != null ? s.light_pct : 0;
        if ($("stLightPct")) $("stLightPct").textContent = format1(lightPct) + " %";
        const dotLight = $("dotLight");
        if (dotLight) {
          dotLight.classList.remove("ok", "warn", "err");
          if (lightOn) dotLight.classList.add("ok");
          else dotLight.classList.add("err");
        }

        // Aktoren - Lüfter
        const fanOn = !!s.fan_on;
        const fanPct = s.fan_pct != null ? s.fan_pct : 0;
        if ($("stFanPct")) $("stFanPct").textContent = format0(fanPct) + " %";
        const dotFan = $("dotFan");
        if (dotFan) {
          dotFan.classList.remove("ok", "warn", "err");
          if (fanOn) dotFan.classList.add("ok");
          else dotFan.classList.add("err");
        }

        // Aktoren - Umluft Lüfter (LED)
        const fan3On = !!s.fan3_on;
        const fan3Pct = s.fan3_pct != null ? s.fan3_pct : 0;
        if ($("stFan3Pct")) $("stFan3Pct").textContent = format0(fan3Pct) + " %";
        const dotFan3 = $("dotFan3");
        if (dotFan3) {
          dotFan3.classList.remove("ok", "warn", "err");
          if (fan3On) dotFan3.classList.add("ok");
          else dotFan3.classList.add("err");
        }

        // Silent-Modus
        const silent = s.silent || {};
        const stSilent = $("stSilentState");
        const dotSilent = $("dotSilent");
        if (stSilent && dotSilent) {
          dotSilent.classList.remove("ok", "warn", "err");
          if (!silent.enabled) {
            stSilent.textContent = "DEAKTIVIERT";
            dotSilent.classList.add("err");
          } else if (silent.active) {
            stSilent.textContent = "AKTIV";
            dotSilent.classList.add("ok");
          } else {
            stSilent.textContent = "STANDBY";
            dotSilent.classList.add("warn");
          }
        }

        // Aktoren - Pumpe (Luft)
        const pumpOn = !!s.pump_on;
        if ($("stPumpState")) $("stPumpState").textContent = pumpOn ? "AN" : "AUS";
        const dotPump = $("dotPump");
        if (dotPump) {
          dotPump.classList.remove("ok", "warn", "err");
          if (pumpOn) dotPump.classList.add("ok");
          else dotPump.classList.add("err");
        }

        // Tür
        const doorOpen = !!s.door_open;
        if ($("stDoor")) $("stDoor").textContent = doorOpen ? "AUF" : "ZU";
        const dotDoor = $("dotDoor");
        if (dotDoor) {
          dotDoor.classList.remove("ok", "warn", "err");
          if (doorOpen) dotDoor.classList.add("warn");
          else dotDoor.classList.add("ok");
        }

        // Netzwerk
        $("stIp").textContent = s.ip || "-";
        $("stNet").textContent = s.wifi_connected ? "verbunden" : "AP-Only";
        $("stRssi").textContent = (s.rssi != null ? s.rssi : "-");
        // Health banner
        const hb = $("healthBanner");
        try {
          const h = s.health || {};
          const err = h.error === true || h.control_paused === true || (h.modules && Object.values(h.modules).some((v) => v === false));
          hb.classList.toggle("ok", !err);
          if (err) {
            const m = []; const mods = h.modules || {};
            if (mods.sht_in === false) m.push("Innen-Sensor SHT41 fehlt/fehlerhaft");
            if (mods.sht_out === false) m.push("Außen-Sensor SHT41 fehlt/fehlerhaft");
            if (mods.dac === false) m.push("LED-DAC (GP8211) nicht erreichbar");
            if (mods.fan === false) m.push("Lüfter-PWM Fehler");
            if (mods.rtc === false) m.push("RTC (DS3231) nicht erreichbar");
            if (mods.tof === false) m.push("ToF-Sensor nicht erreichbar");
            if (mods.i2c0 === false) m.push("I²C-Bus 0 Fehler");
            if (mods.i2c1 === false) m.push("I²C-Bus 1 Fehler");
            if (mods.fs === false) m.push("Dateisystem (LittleFS) Fehler");
            const paused = h.control_paused === true;
            const head = paused ? "Regelung pausiert – Fehler erkannt:" : "Fehler erkannt:";
            const msg = (h.message && h.message.length) ? ("<div>" + h.message + "</div>") : "";
            const list = m.length ? ('<ul class="health-list"><li>' + m.join("</li><li>") + "</li></ul>") : "";
            hb.innerHTML = "<strong>" + head + "</strong>" + msg + list;
          } else { hb.innerHTML = ""; }
        } catch (_) {}
        if (s.ap && s.ap.ssid && s.ap.ip) { $("apInfo").textContent = "AP: " + s.ap.ssid + " @ " + s.ap.ip; }
      }

      async function loadInfo() {
        try {
          const r = await fetch("/api/info"); if (!r.ok) return; const j = await r.json();
          if (j && j.notify) {
            $("notifyEnabled").checked = !!j.notify.enabled;
            $("notifyPhone").value = j.notify.phone || "";
            $("notifyKey").value = j.notify.apikey || "";
            $("notifyBlock").classList.toggle("hidden", !$("notifyEnabled").checked);
          }
          const w = (j && j.wifi) || {};
          $("ssid").value = w.ssid || ""; $("pass").value = ""; $("useStatic").checked = !!w.use_static;
          const st = w.static || {}; $("ip").value = st.ip || ""; $("mask").value = st.mask || ""; $("gw").value = st.gw || ""; $("dns").value = st.dns || "";
          $("staticBlock").classList.toggle("hidden", !$("useStatic").checked);
          
          await loadSilent();
          await loadDoorActions();
        } catch (_) {}
      }

      async function loadSilent() {
        try {
          const r = await fetch("/api/settings/silent");
          if (!r.ok) return;
          const s = await r.json();
          $("silentEnabled").checked = !!s.enabled;
          $("silentStart").value = `${String(s.startH).padStart(2, '0')}:${String(s.startM).padStart(2, '0')}`;
          $("silentEnd").value = `${String(s.endH).padStart(2, '0')}:${String(s.endM).padStart(2, '0')}`;
          $("silentFExhMin").value = s.fanExhaustMin;
          $("silentFExhMax").value = s.fanExhaustMax;
          $("silentFCircMin").value = s.fanCircMin;
          $("silentFCircMax").value = s.fanCircMax;
          $("silentPump").checked = !!s.pumpEnabled;
          $("silentContent").classList.toggle("hidden", !s.enabled);
        } catch (_) {}
      }

      async function loadDoorActions() {
        try {
          const r = await fetch("/api/settings/door_actions");
          if (!r.ok) return;
          const s = await r.json();
          $("doorPauseControl").checked = !!s.pauseControl;
          $("doorLightOn").checked = !!s.lightOn;
          $("doorPumpOff").checked = !!s.pumpOff;
          $("doorLiftPanel").checked = !!s.liftPanel;
        } catch (_) {}
      }

      async function saveDoorActions() {
        const payload = {
          pauseControl: $("doorPauseControl").checked,
          lightOn: $("doorLightOn").checked,
          pumpOff: $("doorPumpOff").checked,
          liftPanel: $("doorLiftPanel").checked
        };
        try {
          console.log("[DEBUG] Saving Door Actions:", payload);
          const res = await fetchJSON("/api/settings/door_actions", { method: "POST", body: JSON.stringify(payload) });
          if (res.ok) {
            showToast("Tür-Maßnahmen gespeichert");
            const btn = $("btnDoorActionsSave");
            const oldText = btn.textContent;
            btn.textContent = "GESPEICHERT";
            btn.style.backgroundColor = "var(--ok)";
            setTimeout(() => {
              btn.textContent = oldText;
              btn.style.backgroundColor = "";
            }, 2000);
          }
        } catch (e) { showToast("Fehler: " + e.message); }
      }
      $("btnDoorActionsSave").addEventListener("click", saveDoorActions);

      async function fetchJSON(url, options) {
        const r = await fetch(url, Object.assign({ headers: { "Content-Type": "application/json" } }, options || {}));
        if (!r.ok) throw new Error(r.status + " " + r.statusText);
        return await r.json().catch(() => ({}));
      }
      function startWS() {
        try {
          const proto = location.protocol === "https:" ? "wss" : "ws";
          live.ws = new WebSocket(proto + "://" + location.host + "/ws");
          live.ws.addEventListener("message", (ev) => { try { updateStatus(JSON.parse(ev.data)); } catch (_) {} });
          live.ws.addEventListener("close", () => { startPolling(); });
          live.ws.addEventListener("error", () => { try { live.ws.close(); } catch (_) {} });
        } catch (_) { startPolling(); }
      }
      function startPolling() {
        if (live.timer) return;
        live.timer = setInterval(async () => { try { const s = await fetchJSON("/api/status"); updateStatus(s); } catch (_) {} }, 3000);
      }

      // Grow start/stop
      document.getElementById("toggleGrow").addEventListener("click", async () => {
        const started = !!(live.lastStatus && live.lastStatus.grow && live.lastStatus.grow.started);
        if (started) { await stopGrow(); return; }
        const tdEl = document.getElementById("totalDays");
        const total_days = tdEl ? parseInt(tdEl.textContent, 10) : 90;
        const startDayInp = document.getElementById("growStartDayInp");
        const start_day = startDayInp ? parseInt(startDayInp.value, 10) : 1;
        const seed = $("seedInp").value.trim();
        
        // Berechne Epoch basierend auf Start-Tag
        const now = Math.floor(Date.now() / 1000);
        const epoch = now - (start_day - 1) * 86400;

        try { 
          await fetch("/api/grow", { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ action: "start", total_days, start_epoch: epoch, seed }) 
          }); 
        } catch (_) {}
      });

      async function stopGrow() {
        if (!confirm("Grow wirklich beenden und zurücksetzen?")) return;
        try { await fetch("/api/grow", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: "stop" }) }); } catch (_) {}
      }

      async function setGrowDay() {
        const day = parseInt($("growCurrentDayInp").value, 10);
        if (isNaN(day) || day < 1) return;
        
        const now = Math.floor(Date.now() / 1000);
        const epoch = now - (day - 1) * 86400;
        
        try {
          await fetch("/api/grow", { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ action: "start", start_epoch: epoch }) 
          });
          showToast("Tag korrigiert auf #" + day);
        } catch (e) { showToast("Fehler: " + e.message); }
      }

      // Trocknung start/stop
      document.getElementById("toggleDry").addEventListener("click", async () => {
        const active = !!(live.lastStatus && live.lastStatus.drying && live.lastStatus.drying.active);
        const action = active ? "stop" : "start";
        try { await fetch("/api/drying", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action }) }); } catch (_) {}
      });

      async function saveNotify() {
        const enabled = $("notifyEnabled").checked; const phone = $("notifyPhone").value.trim(); const rawKey = $("notifyKey").value.trim();
        const hasSavedKey = !!(live.lastStatus && live.lastStatus.notify && live.lastStatus.notify.apikey === "***");
        const apikeySend = (rawKey === "" || rawKey === "***" || rawKey === "*******") ? null : rawKey;
        if (enabled) {
          if (!phoneOk(phone)) { showToast("Telefonnummer ist ungültig (Format +49...)"); return; }
          if (!apikeySend && !hasSavedKey) { showToast("API-Key fehlt"); return; }
        }
        const payload = { enabled, phone }; if (apikeySend) payload.apikey = apikeySend;
        try { await fetchJSON("/api/notify", { method: "POST", body: JSON.stringify(payload) }); showToast("Benachrichtigung gespeichert"); }
        catch (e) {
          try { await fetchJSON("/api/network", { method: "POST", body: JSON.stringify({ notify: payload }) }); showToast("Benachrichtigung gespeichert"); }
          catch (e2) { showToast("Fehler beim Speichern: " + e2.message); }
        }
      }
      $("btnNotifySave").addEventListener("click", saveNotify);
      btnNotifyTest.addEventListener("click", async () => {
        const en = notifyEnabled.checked; const phone = notifyPhone.value.trim(); const key = notifyKey.value.trim(); const masked = key === "" || key === "***" || key === "*******";
        try { fetch(location.origin + "/api/debug/touch?stage=clicked&en=" + (en ? 1 : 0) + "&phoneLen=" + phone.length + "&key=" + (masked ? 0 : 1)).catch(() => {}); } catch (_) {}
        if (!en) { showToast("Benachrichtigungen sind deaktiviert"); return; }
        if (!phoneOk(phone)) { try { fetch(location.origin + "/api/debug/touch?stage=blocked_phone").catch(() => {}); } catch (_) {} showToast("Telefonnummer ist ungültig (Format +49...)"); return; }
        if (!masked && !key) { try { fetch(location.origin + "/api/debug/touch?stage=blocked_key").catch(() => {}); } catch (_) {} showToast("API-Key fehlt"); return; }
        try {
          showToast("Sende Testnachricht...");
          try { fetch(location.origin + "/api/debug/touch?stage=sendreq").catch(() => {}); } catch (__) {}
          const body = masked ? { phone } : { phone, apikey: key };
          const r = await fetch(location.origin + "/api/notify/test", { method: "POST", headers: { "Content-Type": "application/json", "Cache-Control": "no-cache" }, cache: "no-store", body: JSON.stringify(body) });
          if (!r.ok) { const t = await r.text().catch(() => ""); try { fetch(location.origin + "/api/debug/touch?stage=resp_err").catch(() => {}); } catch (__) {} throw new Error(r.status + " " + r.statusText + " " + t); }
          try { fetch(location.origin + "/api/debug/touch?stage=resp_ok").catch(() => {}); } catch (__) {}
          showToast("Testnachricht gesendet (siehe WhatsApp)");
        } catch (e) { showToast("Fehler beim Senden: " + e.message); }
      });
      $("btnNetSave").addEventListener("click", async () => {
        const ssid = $("ssid").value.trim(); const pass = $("pass").value; const useStatic = $("useStatic").checked;
        const ip = $("ip").value.trim(); const mask = $("mask").value.trim(); const gw = $("gw").value.trim(); const dns = $("dns").value.trim();
        const wantsStaticBlock = useStatic || ip || mask || gw || dns;
        if (!ssid && !wantsStaticBlock) { showToast("Keine WLAN-Änderungen erkannt"); return; }
        if (useStatic) {
          for (const [val, label] of [[ip, "IP-Adresse"], [mask, "Subnetzmaske"], [gw, "Gateway"]]) {
            if (!ipv4ok(val)) { showToast("Ungültige IPv4 in " + label); return; }
          }
          if (dns && !ipv4ok(dns)) { showToast("Ungültige IPv4 in DNS"); return; }
        }
        const payload = {}; if (ssid) payload.ssid = ssid; if (pass) payload.pass = pass; payload.use_static = !!useStatic; payload.static = useStatic ? { ip, mask, gw, dns } : null; payload.reboot = true;
        showToastHtml('WLAN gespeichert. Bitte jetzt ins Heimnetz wechseln und <a href="http://luminagrowx.local/" target="_blank">http://luminagrowx.local/</a> aufrufen.');
        try { fetch("/api/network", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }); } catch (_) {}
      });

      $("silentEnabled").addEventListener("change", () => $("silentContent").classList.toggle("hidden", !$("silentEnabled").checked));
      
      function validateMinMax(minId, maxId, label) {
        const minVal = parseFloat($(minId).value);
        const maxVal = parseFloat($(maxId).value);
        if (minVal < 0 || maxVal < 0 || minVal > 100 || maxVal > 100) {
          showToast(`Werte für ${label} müssen zwischen 0% und 100% liegen.`);
          return false;
        }
        if (minVal > maxVal) {
          showToast(`Das Minimum für ${label} darf nicht größer als das Maximum sein.`);
          return false;
        }
        return true;
      }

      $("btnSilentSaveMain").addEventListener("click", async () => {
        if (!validateMinMax("silentFExhMin", "silentFExhMax", "Abluft-Lüfter")) return;
        if (!validateMinMax("silentFCircMin", "silentFCircMax", "Umluft-Lüfter")) return;

        try {
          const startArr = $("silentStart").value.split(":");
          const endArr = $("silentEnd").value.split(":");
          const body = {
            enabled: $("silentEnabled").checked,
            startH: parseInt(startArr[0] || 22),
            startM: parseInt(startArr[1] || 0),
            endH: parseInt(endArr[0] || 6),
            endM: parseInt(endArr[1] || 0),
            fanExhaustMin: parseFloat($("silentFExhMin").value),
            fanExhaustMax: parseFloat($("silentFExhMax").value),
            fanCircMin: parseFloat($("silentFCircMin").value),
            fanCircMax: parseFloat($("silentFCircMax").value),
            pumpEnabled: $("silentPump").checked
          };
          await fetchJSON("/api/settings/silent", { method: "POST", body: JSON.stringify(body) });
          showToast("Silent-Einstellungen gespeichert");
        } catch (e) { showToast("Fehler: " + e.message); }
      });

      // Icons initialisieren
      function initIcons() {
        const iconKlimaIn = $("iconKlimaIn"); if (iconKlimaIn) iconKlimaIn.innerHTML = icons.plant;
        const iconAktoren = $("iconAktoren"); if (iconAktoren) iconAktoren.innerHTML = icons.bolt;
        const iconRaum = $("iconRaum"); if (iconRaum) iconRaum.innerHTML = icons.home;
        const iconSystem = $("iconSystem"); if (iconSystem) iconSystem.innerHTML = icons.cpu;
      }
      initIcons();
      let phasesData = [];
      let currentPhaseIdx = 0;
      const phaseSel = $("phaseSel");
      const toggleProfi = $("toggleProfi");
      const profiBlock = $("profiBlock");

      toggleProfi.addEventListener("change", () => {
        profiBlock.classList.toggle("hidden", !toggleProfi.checked);
      });

      function renderModeInputs(modeKey, label) {
        return `
          <div class="mode-settings-block">
            <strong class="mode-label">${label}</strong>
            <div class="mode-inputs-list">
              <div class="input-row"><label>LED</label><input type="number" step="1" min="0" max="100" data-mode="${modeKey}" data-field="led"><span class="unit">%</span></div>
              <div class="input-row"><label>Lüfter Min</label><input type="number" step="1" min="0" max="100" data-mode="${modeKey}" data-field="fan_min"><span class="unit">%</span></div>
              <div class="input-row"><label>Lüfter Max</label><input type="number" step="1" min="0" max="100" data-mode="${modeKey}" data-field="fan_max"><span class="unit">%</span></div>
              <div class="input-row"><label>VPD Min</label><input type="number" step="0.01" min="0" data-mode="${modeKey}" data-field="vpd_min"><span class="unit">kPa</span></div>
              <div class="input-row"><label>VPD Max</label><input type="number" step="0.01" min="0" data-mode="${modeKey}" data-field="vpd_max"><span class="unit">kPa</span></div>
            </div>
          </div>
        `;
      }

      function renderPhase(idx) {
        idx = parseInt(idx);
        if (isNaN(idx) || !phasesData[idx]) return;
        const p = phasesData[idx];
        const s = p.schedule;
        $("phOn").value = s.on || "06:00";
        $("phOff").value = s.off || "00:00";
        $("phRise").value = s.sunrise_min || 0;
        $("phSet").value = s.sunset_min || 0;
        $("phFCircMin").value = p.settings.day.fan_circ_min;
        $("phFCircMax").value = p.settings.day.fan_circ_max;
        $("phPump").checked = !!s.pump;

        const modesDiv = $("modesGrid");
        modesDiv.innerHTML = 
          renderModeInputs("day", "Tag (Licht AN)") +
          renderModeInputs("night", "Nacht (Licht AUS)");
        
        const inputs = modesDiv.querySelectorAll("input");
        inputs.forEach(inp => {
          const m = inp.dataset.mode;
          const f = inp.dataset.field;
          if (p.settings[m] && p.settings[m][f] !== undefined) {
            if (inp.type === "checkbox") inp.checked = !!p.settings[m][f];
            else inp.value = p.settings[m][f];
          }
        });
        currentPhaseIdx = idx;
      }

      function collectCurrentPhaseData(idx) {
        if (idx === undefined) idx = currentPhaseIdx;
        if (!phasesData || !phasesData[idx]) return;
        const p = phasesData[idx];
        if (!p.schedule) p.schedule = {};
        if (!p.settings) p.settings = {};
        
        // Save global schedule fields to current phase slot
        p.schedule.on = $("phOn").value;
        p.schedule.off = $("phOff").value;
        p.schedule.sunrise_min = parseInt($("phRise").value) || 0;
        p.schedule.sunset_min = parseInt($("phSet").value) || 0;
        p.schedule.pump = $("phPump").checked;

        const fCircMin = parseFloat($("phFCircMin").value) || 0;
        const fCircMax = parseFloat($("phFCircMax").value) || 0;
        ["day", "night", "night_silent"].forEach(m => {
          p.settings[m].fan_circ_min = fCircMin;
          p.settings[m].fan_circ_max = fCircMax;
        });

        // Save mode-specific fields from the grid
        const modesDiv = $("modesGrid");
        const inputs = modesDiv.querySelectorAll("input");
        inputs.forEach(inp => {
          const m = inp.dataset.mode;
          const f = inp.dataset.field;
          if (inp.type === "checkbox") {
            p.settings[m][f] = inp.checked;
          } else {
            let val = parseFloat(inp.value);
            if (isNaN(val)) return;
            if (f === "led" || f.startsWith("fan")) val = Math.round(val);
            p.settings[m][f] = val;
          }
        });
      }

      phaseSel.addEventListener("change", () => {
        // 1. Save what's currently on screen to the OLD index
        collectCurrentPhaseData(currentPhaseIdx);
        // 2. Load and render the NEW index
        renderPhase(parseInt(phaseSel.value));
      });

      async function loadPhases() {
        try {
          const r = await fetch("/api/settings/phases");
          if (!r.ok) return;
          const j = await r.json();
          if (j.phases) {
            phasesData = j.phases;
            // Set currentPhaseIdx to whatever the selector says and render it
            const startIdx = parseInt(phaseSel.value);
            currentPhaseIdx = startIdx;
            renderPhase(startIdx);
          }
        } catch(e) { console.error("loadPhases Error:", e); }
      }

      $("btnSavePhases").addEventListener("click", async () => {
        // Ensure current UI state is captured in phasesData array
        collectCurrentPhaseData(currentPhaseIdx);

        // Validation
        const fCircMin = parseFloat($("phFCircMin").value);
        const fCircMax = parseFloat($("phFCircMax").value);
        if (fCircMin < 0 || fCircMax < 0 || fCircMin > 100 || fCircMax > 100) {
          showToast("LED-Lüfter Werte müssen zwischen 0% und 100% liegen.");
          return;
        }
        if (fCircMin > fCircMax) {
          showToast("LED-Lüfter: Minimum darf nicht größer als das Maximum sein.");
          return;
        }

        for (const p of phasesData) {
          const modes = ["day", "night", "night_silent"];
          for (const m of modes) {
            const s = p.settings[m];
            if (s.led < 0 || s.led > 100) { showToast(`Phase ${p.name}: LED % muss 0-100 sein.`); return; }
            if (s.fan_min < 0 || s.fan_min > 100) { showToast(`Phase ${p.name}: Lüfter Min % muss 0-100 sein.`); return; }
            if (s.fan_max < 0 || s.fan_max > 100) { showToast(`Phase ${p.name}: Lüfter Max % muss 0-100 sein.`); return; }
            if (s.fan_min > s.fan_max) { showToast(`Phase ${p.name}: Lüfter Min darf nicht größer als Max sein.`); return; }
            if (s.vpd_min < 0 || s.vpd_max < 0) { showToast(`Phase ${p.name}: VPD muss positiv sein.`); return; }
            if (s.vpd_min > s.vpd_max) { showToast(`Phase ${p.name}: VPD Min darf nicht größer als Max sein.`); return; }
          }
        }

        try {
          const resp = await fetch("/api/settings/phases", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({phases: phasesData})
          });
          const res = await resp.json();
          if (res.ok) showToast("Einstellungen gespeichert!");
          else throw new Error(res.error || "Unbekannter Fehler");
        } catch(e) { showToast("Fehler beim Speichern: " + e.message); }
      });

      $("btnResetPhases").addEventListener("click", async () => {
        if (!confirm("Möchtest du wirklich alle Phasen-Einstellungen auf Werkseinstellungen zurücksetzen?")) return;
        try {
          const resp = await fetch("/api/settings/phases/reset", { method: "POST" });
          const res = await resp.json();
          if (res.ok) {
            showToast("Werkseinstellungen wiederhergestellt!");
            await loadPhases(); // Reload data from server
          } else throw new Error(res.error || "Reset fehlgeschlagen");
        } catch(e) { showToast("Fehler: " + e.message); }
      });

      (async function () { await loadInfo(); await loadPhases(); startWS(); try { const s = await fetchJSON("/api/status"); updateStatus(s); } catch (_) {} })();
    </script>
  </body>
</html>