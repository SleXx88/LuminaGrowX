<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lisa Pro - Growbox</title>
    <link rel="stylesheet" href="/pico.min.css" />
    <style>
      :root {
        --accent: #ef4444;
        --accent-2: #dc2626;
        --glass: rgba(20, 20, 22, 0.42);
        --glass-strong: rgba(20, 20, 22, 0.62);
        --muted: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.18);
        --text: #e5e7eb;
        --text-dim: #cbd5e1;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --radius: 18px;
        --pico-background-color: transparent;
        --pico-card-background-color: transparent;
      }
      html,
      body { height: 100%; }
      body {
        position: relative;
        color: var(--text);
        background: transparent;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.55)), url("/bg.jpg") center/cover no-repeat #0b0b0c;
        z-index: -1;
      }
      header.hero, article, footer.site, dialog.modal article {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        backdrop-filter: blur(3px);
      }
      article > header {
        background: var(--glass-strong);
        border-bottom: 1px solid var(--border);
        border-radius: var(--radius) var(--radius) 0 0;
        padding: 0.75rem 1rem;
      }
      a, h1, h2, h3, h4, h5 { color: var(--text); }
      .grid { gap: 1rem; }
      .status-grid { display: grid; grid-template-columns: 1fr; }
      header.hero { padding: 1rem; }
      main.container { flex: 1; display: flex; flex-direction: column; }
      header.hero h1.brand {
        font-size: clamp(2.2rem, 6vw, 3.3rem);
        letter-spacing: 0.04em;
        margin: 0.25rem 0 0;
        position: relative;
        display: inline-flex;
        align-items: flex-start;
        gap: 0.25rem;
      }
      .brand-word { color: #ffffff; font-weight: 800; }
      .brand-pro { color: var(--accent); font-weight: 800; font-size: 0.55em; line-height: 1; vertical-align: super; position: relative; top: -0.25em; }
      header.hero p.subtitle { margin: 0.25rem 0 0; opacity: 0.85; color: var(--text-dim); }
      .health-banner { margin-top: 0.6rem; padding: 0.6rem 0.8rem; border-radius: var(--radius); border: 1px solid var(--border); background: rgba(239, 68, 68, 0.12); color: var(--text); }
      .health-banner.ok { display: none; }
      .health-list { margin: 0.25rem 0 0; padding-left: 1rem; }
      .badge {
        display: inline-flex; align-items: center; gap: 0.4rem;
        font-size: 0.85rem; padding: 0.25rem 0.5rem; border-radius: 999px;
        background: var(--glass-strong); border: 1px solid var(--border);
      }
      .badge-accent {
        display: inline-flex; align-items: center; gap: 0.4rem;
        font-size: 0.85rem; padding: 0.25rem 0.55rem; border-radius: 999px;
        background: var(--accent); color: #fff; border: 1px solid var(--accent);
        text-decoration: none;
      }
      /* Firmware-Badges als Stapel: neuer Badge leicht über altem */
      .fw-stack { display: inline-flex; align-items: center; gap: 0.3rem; }
      .dot { width: 0.55rem; height: 0.55rem; border-radius: 50%; background: #9ca3af; display: inline-block; }
      .dot.ok { background: var(--ok); }
      .dot.warn { background: var(--warn); }
      .dot.err { background: var(--err); }
      .icon { display: inline-flex; align-items: center; justify-content: center; line-height: 0; }
      .icon svg { width: 18px; height: 18px; display: block; }
      .icon.ok { color: var(--ok); } .icon.warn { color: var(--warn); } .icon.err { color: var(--err); }
      .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .nav-status { display: flex; flex-direction: column; gap: 0.04rem; align-items: flex-end; }
      .nav-status > li { margin: 0; }
      .nav-status-row { display: flex; gap: 0.3rem; align-items: center; }
      .hidden { display: none !important; }
      input, select, button, [role="button"], .button { border-radius: var(--radius); }
      input, select { background: rgba(255, 255, 255, 0.02) !important; color: var(--text) !important; border: 1px solid var(--border) !important; }
      button, [role="button"], .button { background: rgba(20, 20, 22, 0.42); color: var(--text); border: 1px solid var(--border); font-weight: 700; font-size: 1rem; line-height: 1.2; padding: 0.55rem 0.9rem; border-radius: var(--radius) !important; }
      /* Desktop/Laptop: etwas kompaktere Buttons */
      @media (min-width: 768px) {
        button, [role="button"], .button { font-size: 0.95rem; padding: 0.5rem 0.85rem; }
      }
      @media (min-width: 1200px) {
        button, [role="button"], .button { font-size: 0.9rem; padding: 0.45rem 0.8rem; }
      }
      button:hover { background: rgba(255, 255, 255, 0.06); }
      button:active, button.primary, .primary { background: var(--accent) !important; color: #fff !important; border-color: var(--accent) !important; }
      input[type="checkbox"], input[type="radio"] { accent-color: var(--accent); }
      input[type="checkbox"] { width: 1.1rem; height: 1.1rem; margin-right: 0.5rem; border: 2px solid var(--border) !important; background: rgba(255, 255, 255, 0.06) !important; }
      label > input[type="checkbox"] { vertical-align: middle; }
      footer.site { padding: 0.9rem 1.1rem; }
      .grow-title { font-size: clamp(1.4rem, 3.5vw, 2rem); margin: 0; }
      .grow-meta { display: flex; gap: 1rem; flex-wrap: wrap; color: var(--text-dim); }
      .progress { height: 10px; background: rgba(255, 255, 255, 0.12); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
      .progress > span { display: block; height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
    </style>
  </head>
  <body>
    <header class="hero container">
      <nav>
        <ul>
          <li>
            <h1 class="brand"><span class="brand-word">LISA</span><span class="brand-pro">pro</span></h1>
            <p class="subtitle">Automatisierte Growbox</p>
          </li>
        </ul>
        <ul class="nav-status">
          <li class="nav-status-row">
            <span class="badge" title="Internetverbindung"><span id="liveIcon" class="icon"></span></span>
            <span class="badge" title="Benachrichtigungen"><span id="waIcon" class="icon"></span></span>
            <span class="fw-stack" title="Firmware">
              <span class="badge fw-old"><span id="fwTop" class="mono">-</span></span>
              <a id="fwTopUpd" class="badge-accent fw-new" href="/update" style="display:none"></a>
            </span>
          </li>
          <li class="nav-status-row">
            <span class="badge" title="Datum/Uhrzeit"><span id="ntpTop" class="mono">--</span></span>
          </li>
        </ul>
      </nav>
      <div id="healthBanner" class="health-banner ok"></div>
    </header>

    <main class="container">
      <div class="grid" style="margin-top: 1rem">
        <article>
          <header><h2>Grow</h2></header>
          <div class="content" style="padding: 1rem; display: grid; gap: 0.8rem">
            <h3 id="growTitle" class="grow-title">Noch nicht gestartet</h3>
            <div class="grow-meta">
              <span>Gesamt: <strong><span id="totalDays">90</span> Tage</strong></span>
              <span>Start: <strong><span id="growStart">-</span></strong></span>
            </div>
            <div class="progress"><span id="growProgress"></span></div>
            <div style="display: flex; gap: 0.5rem">
              <button id="toggleGrow" type="button">START</button>
            </div>
          </div>
        </article>

        <article>
          <header><h2>Trocknung</h2></header>
          <div class="content" style="padding: 1rem; display: grid; gap: 0.8rem">
            <h3 id="dryTitle" class="grow-title">Nicht aktiv</h3>
            <div class="grow-meta">
              <span>Dauer: <strong>14 Tage</strong></span>
              <span>Start: <strong><span id="dryStart">-</span></strong></span>
            </div>
            <div class="progress"><span id="dryProgress"></span></div>
            <p style="font-size: 0.9rem; color: var(--text-dim); margin: 0;">
              <strong>Bedingungen:</strong> 45-55% RH, LED aus, min. 20% Lüfter für Luftaustausch
            </p>
            <div style="display: flex; gap: 0.5rem">
              <button id="toggleDry" type="button">TROCKNUNG STARTEN</button>
            </div>
          </div>
        </article>

        <article>
          <header><h2>Live Status</h2></header>
          <div class="content" style="padding: 0.75rem; display: grid; gap: 0.75rem;">
            <!-- Growbox -->
            <div style="padding: 0.5rem; background: rgba(239, 68, 68, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--accent); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="display: inline-flex; width: 0.9rem; height: 0.9rem; color: var(--accent);" id="iconGrowbox"></span>
                <span>Growbox</span>
              </div>

              <!-- Umgebungsdaten -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem;">Temperatur</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);" class="mono" id="stT">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">°C</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem;">Luftfeuchte</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);" class="mono" id="stH">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">% rF</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem;">VPD</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);" class="mono" id="stVpd">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">kPa</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem;">Taupunkt</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);" class="mono" id="stDew">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">°C</div>
                </div>
              </div>

              <!-- Aktoren -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotLight"></span>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">LED</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700; color: var(--text);" class="mono" id="stLightPct">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);" id="stLightState">-</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotFan"></span>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">Lüfter</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700; color: var(--text);" class="mono" id="stFanPct">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);" id="stFanState">-</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotPump"></span>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">Pumpe</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700; color: var(--text);" class="mono" id="stPumpState">AUS</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.2rem;">
                    <span class="dot" id="dotDoor"></span>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">Tür</div>
                  </div>
                  <div style="font-size: 1rem; font-weight: 700; color: var(--text);" class="mono" id="stDoor">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">Status</div>
                </div>
              </div>
            </div>

            <!-- Umgebungsdaten AUSSEN -->
            <div style="padding: 0.5rem; background: rgba(59, 130, 246, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: #60a5fa; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.3rem;">
                <span style="display: inline-flex; width: 0.9rem; height: 0.9rem; color: #60a5fa;" id="iconAussen"></span>
                <span>AUSSEN (Raum)</span>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem;">Temperatur</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);" class="mono" id="stTOut">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">°C</div>
                </div>
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem;">Luftfeuchte</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);" class="mono" id="stHOut">-</div>
                  <div style="font-size: 0.65rem; color: var(--text-dim);">% rF</div>
                </div>
              </div>
            </div>

            <!-- System -->
            <div style="padding: 0.5rem; background: rgba(156, 163, 175, 0.08); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
              <div style="font-size: 0.75rem; font-weight: 600; color: #9ca3af; margin-bottom: 0.4rem;">System</div>
              <div style="display: grid; gap: 0.5rem;">
                <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                  <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem; display: flex; align-items: center; gap: 0.3rem;">
                    <span style="display: inline-flex; width: 0.7rem; height: 0.7rem; color: var(--text-dim);" id="iconUptime"></span>
                    <span>Uptime</span>
                  </div>
                  <div style="font-size: 1rem; font-weight: 600; color: var(--text);" class="mono" id="stUp">-</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                  <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                    <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem; display: flex; align-items: center; gap: 0.3rem;">
                      <span style="display: inline-flex; width: 0.7rem; height: 0.7rem; color: var(--text-dim);" id="iconIp"></span>
                      <span>IP-Adresse</span>
                    </div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text);" class="mono" id="stIp">-</div>
                    <div style="font-size: 0.65rem; color: var(--text-dim); margin-top: 0.15rem;" id="stNet">-</div>
                  </div>
                  <div style="padding: 0.5rem; background: var(--muted); border: 1px solid var(--border); border-radius: calc(var(--radius) * 0.7);">
                    <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.15rem; display: flex; align-items: center; gap: 0.3rem;">
                      <span style="display: inline-flex; width: 0.7rem; height: 0.7rem; color: var(--text-dim);" id="iconRssi"></span>
                      <span>RSSI</span>
                    </div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text);" class="mono" id="stRssi">-</div>
                    <div style="font-size: 0.65rem; color: var(--text-dim); margin-top: 0.15rem;">dBm</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </article>

      </div>
      <div style="display: flex; gap: 0.5rem; padding: 1rem 0; margin-top: auto;">
        <a href="/settings" class="button" role="button">Einstellungen</a>
        <a href="/update" class="button" role="button">Update</a>
      </div>
    </main>

    <footer class="site container">
      <small style="display:block">&copy; 2025 Martin Teske – Alle Rechte vorbehalten.</small>
      <small style="display:block">
        <strong>LuminaGrowX</strong> ist eine Open-Source-Software von 
        <a href="https://martinteske-blog.de" target="_blank">MartinTeske-Blog.de</a>, 
        entwickelt für die <strong>LisaPro Growbox</strong>.
        <br>
        Die LisaPro Growbox ist exklusiv erhältlich bei 
        <a href="https://mutualgarden.de" target="_blank">MutualGarden.de</a>.
      </small>
      <small style="display:block"><span id="apInfo" class="mono"></span></small>
    </footer>

    <dialog id="dlgNet" class="modal">
      <article>
        <header>
          <h3>Einstellungen</h3>
          <button aria-label="Schließen" rel="prev" onclick="document.getElementById('dlgNet').close()"></button>
        </header>
        <div class="content" style="padding: 1rem; display: grid; gap: 1rem">
          <form id="netForm">
            <h4>WLAN</h4>
            <div class="grid">
              <label>SSID <input id="ssid" name="ssid" placeholder="MeinWiFi" /></label>
              <label>Passwort <input id="pass" name="pass" type="password" placeholder="********" /></label>
            </div>
            <div class="grid">
              <label><input type="checkbox" id="useStatic" name="useStatic" role="switch" /> Statische IP-Adresse verwenden</label>
            </div>
            <div id="staticBlock" class="grid hidden">
              <label>IP-Adresse <input id="ip" name="ip" placeholder="192.168.1.50" /></label>
              <label>Subnetzmaske <input id="mask" name="mask" placeholder="255.255.255.0" /></label>
              <label>Gateway <input id="gw" name="gw" placeholder="192.168.1.1" /></label>
              <label>DNS (optional) <input id="dns" name="dns" placeholder="1.1.1.1" /></label>
            </div>

            <footer style="display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 0.5rem;">
              <button type="button" id="btnNetSave" class="primary">Speichern</button>
            </footer>

            <hr />
            <h4>Benachrichtigungen (WhatsApp via CallMeBot)</h4>
            <label><input type="checkbox" id="notifyEnabled" role="switch" /> Benachrichtigungen aktivieren</label>
            <div id="notifyBlock" class="grid hidden">
              <label>Telefonnummer (+Ländervorwahl) <input id="notifyPhone" placeholder="+49XXXXXXXXXX" /></label>
              <label>API-Key <input id="notifyKey" placeholder="1234567" /></label>
              <div style="display: flex; gap: 0.5rem">
                <button id="btnNotifySave" type="button" class="primary">Speichern</button>
                <button id="btnNotifyTest" type="button">Testnachricht senden</button>
              </div>
            </div>
          </form>
        </div>
        <footer style="display: flex; justify-content: flex-end; padding: 0.75rem 1rem;">
          <button type="button" onclick="document.getElementById('dlgNet').close()">Schließen</button>
        </footer>
      </article>
    </dialog>

    <dialog id="toast" class="modal">
      <article>
        <header><strong>Status</strong></header>
        <div class="content" style="padding: 1rem"><p id="toastMsg">-</p></div>
        <footer style="display: flex; justify-content: flex-end; padding: 0.75rem 1rem;">
          <button onclick="document.getElementById('toast').close()">OK</button>
        </footer>
      </article>
    </dialog>

    <script>
      const $ = (id) => document.getElementById(id);
      // Inline, lizenzfreie SVG-Icons (Check/X/Minus) – Heroicons-ähnlich
      const icons = {
        wifi: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M3 12h18"/><path d="M12 3a14 14 0 0 1 0 18"/><path d="M12 3a14 14 0 0 0 0 18"/></svg>',
        mail: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2" ry="2"/><path d="M3 7l9 6 9-6" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        thermo: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M14 14.76V5a2 2 0 1 0-4 0v9.76a4 4 0 1 0 4 0Z"/></svg>',
        plant: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 22v-9m0 0c-1.5-2-4-3-7-3 0 5 3 7 7 7Zm0 0c1.5-2 4-3 7-3 0 5-3 7-7 7ZM12 13V2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        home: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        clock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        network: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
        signal: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M5 18v-6m4 6V9m4 9V6m4 12v-9" stroke-linecap="round" stroke-linejoin="round"/></svg>',
      };
      const live = { ws: null, timer: null, lastStatus: null };
      let netDialogOpen = false;
      function showToast(msg) {
        const p = $("toastMsg"); p.textContent = msg; $("toast").showModal();
      }
      function showToastHtml(html) {
        const p = $("toastMsg"); p.innerHTML = html; $("toast").showModal();
      }
      function ipv4ok(s) { const parts = (s || "").split(".").map((n) => +n); return (parts.length === 4 && parts.every((n) => Number.isInteger(n) && n >= 0 && n <= 255)); }
      function phoneOk(s) { return /^\+\d{6,16}$/.test((s || "").trim()); }
      function format1(n) { return n == null || isNaN(n) ? "-" : (+n).toFixed(1); }
      function format0(n) { return n == null || isNaN(n) ? "-" : Math.round(+n).toString(); }
      function formatUptime(sec) {
        if (sec == null || isNaN(sec)) return "-";
        sec = Math.floor(+sec);
        const d = Math.floor(sec / 86400); sec -= d*86400;
        const h = Math.floor(sec / 3600);  sec -= h*3600;
        const m = Math.floor(sec / 60);    const s = sec - m*60;
        if (d > 0) return `${d}d ${h}h ${m}m`;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        return `${m}m ${s}s`;
      }
      function updateToggleButton(started) { $("toggleGrow").textContent = started ? "STOP" : "START"; $("toggleGrow").classList.toggle("primary", started); }
      function updateDryButton(active) { $("toggleDry").textContent = active ? "TROCKNUNG STOPPEN" : "TROCKNUNG STARTEN"; $("toggleDry").classList.toggle("primary", active); }

      function updateStatus(s) {
        live.lastStatus = s;
        // Internet/WLAN
        const liveEl = $("liveIcon");
        if (liveEl) {
          if (!liveEl.innerHTML) liveEl.innerHTML = icons.wifi;
          liveEl.classList.remove("ok", "warn", "err");
          if (s && s.internet_ok) liveEl.classList.add("ok"); else if (s && s.wifi_connected) liveEl.classList.add("warn"); else liveEl.classList.add("err");
        }
        // Benachrichtigungen
        const waEl = $("waIcon");
        if (waEl) {
          if (!waEl.innerHTML) waEl.innerHTML = icons.mail;
          waEl.classList.remove("ok", "warn", "err");
          const enabled = !!(s && s.notify && s.notify.enabled);
          waEl.classList.add(enabled ? "ok" : "err");
        }

        if (s.grow) {
          $("growTitle").textContent = s.grow.started ? ("Tag " + s.grow.day + " - " + (s.grow.phase || "")) : "Noch nicht gestartet";
          totalDays.textContent = (s.grow.total_days != null ? s.grow.total_days : 90);
          $("growStart").textContent = s.grow.start_epoch ? new Date(s.grow.start_epoch * 1000).toLocaleString() : "";
          const total = s.grow.total_days || 0, day = s.grow.day || 0;
          const pct = total > 0 ? Math.min(100, Math.round((day / total) * 100)) : 0;
          $("growProgress").style.width = pct + "%";
          updateToggleButton(s.grow.started);
        }
        // Trocknung
        if (s.drying) {
          const dryActive = !!s.drying.active;
          $("dryTitle").textContent = dryActive ? ("Tag " + (s.drying.day || 0) + " von 14") : "Nicht aktiv";
          $("dryStart").textContent = s.drying.start_epoch ? new Date(s.drying.start_epoch * 1000).toLocaleString() : "-";
          const dryDay = s.drying.day || 0;
          const dryPct = Math.min(100, Math.round((dryDay / 14) * 100));
          $("dryProgress").style.width = dryPct + "%";
          updateDryButton(dryActive);
          // Gegenseitige Sperre: Grow-Button disabled wenn Trocknung aktiv
          const growBtn = $("toggleGrow");
          if (growBtn) {
            growBtn.disabled = dryActive;
            if (dryActive) growBtn.title = "Nicht verfügbar während Trocknung";
            else growBtn.title = "";
          }
          // Trocknungs-Button disabled wenn Grow aktiv
          const dryBtn = $("toggleDry");
          if (dryBtn && s.grow) {
            dryBtn.disabled = s.grow.started;
            if (s.grow.started) dryBtn.title = "Nicht verfügbar während Grow";
            else dryBtn.title = "";
          }
        }
        // System/Env/Aktoren
        const up = (typeof s.uptime_s !== 'undefined') ? s.uptime_s : s.uptime;
        $("stUp").textContent = formatUptime(up);
        if ($("stNtp")) $("stNtp").textContent = s.ntp_time || "-";
        const ntpTopEl = document.getElementById("ntpTop"); if (ntpTopEl) ntpTopEl.textContent = s.ntp_time || "--";

        // Umgebung - BOX (Innen)
        $("stT").textContent = format1(s.temp_c);
        $("stH").textContent = format1(s.humi_rh);
        $("stVpd").textContent = format1(s.vpd_kpa);
        if ($("stDew")) $("stDew").textContent = format1(s.dew_c);

        // Umgebung - AUSSEN (Raum)
        if ($("stTOut")) $("stTOut").textContent = format1(s.temp_out_c);
        if ($("stHOut")) $("stHOut").textContent = format1(s.humi_out_rh);

        // Firmware im Hero
        const fwTop = document.getElementById('fwTop'); if (fwTop) fwTop.textContent = (s.fw || '-');
        const fwTopUpd = document.getElementById('fwTopUpd');
        if (fwTopUpd) {
          if (s.update && s.update.has_update && s.update.latest) {
            fwTopUpd.style.display = '';
            fwTopUpd.textContent = 'Neu: ' + s.update.latest;
          } else {
            fwTopUpd.style.display = 'none'; fwTopUpd.textContent = '';
          }
        }

        // Aktoren - LED
        const lightOn = !!s.light_on;
        const lightPct = s.light_pct != null ? s.light_pct : 0;
        if ($("stLightPct")) $("stLightPct").textContent = format1(lightPct) + " %";
        if ($("stLightState")) $("stLightState").textContent = lightOn ? "AN" : "AUS";
        const dotLight = $("dotLight");
        if (dotLight) {
          dotLight.classList.remove("ok", "warn", "err");
          if (lightOn) dotLight.classList.add("ok");
          else dotLight.classList.add("err");
        }

        // Aktoren - Lüfter
        const fanOn = !!s.fan_on;
        const fanPct = s.fan_pct != null ? s.fan_pct : 0;
        if ($("stFanPct")) $("stFanPct").textContent = format0(fanPct) + " %";
        if ($("stFanState")) $("stFanState").textContent = fanOn ? "AN" : "AUS";
        const dotFan = $("dotFan");
        if (dotFan) {
          dotFan.classList.remove("ok", "warn", "err");
          if (fanOn) dotFan.classList.add("ok");
          else dotFan.classList.add("err");
        }

        // Aktoren - Pumpe
        const pumpOn = !!s.pump_on;
        if ($("stPumpState")) $("stPumpState").textContent = pumpOn ? "AN" : "AUS";
        const dotPump = $("dotPump");
        if (dotPump) {
          dotPump.classList.remove("ok", "warn", "err");
          if (pumpOn) dotPump.classList.add("ok");
          else dotPump.classList.add("err");
        }

        // Tür
        const doorOpen = !!s.door_open;
        if ($("stDoor")) $("stDoor").textContent = doorOpen ? "AUF" : "ZU";
        const dotDoor = $("dotDoor");
        if (dotDoor) {
          dotDoor.classList.remove("ok", "warn", "err");
          if (doorOpen) dotDoor.classList.add("warn");
          else dotDoor.classList.add("ok");
        }

        // Netzwerk
        $("stIp").textContent = s.ip || "-";
        $("stNet").textContent = s.wifi_connected ? "verbunden" : "AP-Only";
        $("stRssi").textContent = (s.rssi != null ? s.rssi : "-");
        // Health banner
        const hb = $("healthBanner");
        try {
          const h = s.health || {};
          const err = h.error === true || h.control_paused === true || (h.modules && Object.values(h.modules).some((v) => v === false));
          hb.classList.toggle("ok", !err);
          if (err) {
            const m = []; const mods = h.modules || {};
            if (mods.sht_in === false) m.push("Innen-Sensor SHT41 fehlt/fehlerhaft");
            if (mods.sht_out === false) m.push("Außen-Sensor SHT41 fehlt/fehlerhaft");
            if (mods.dac === false) m.push("LED-DAC (GP8211) nicht erreichbar");
            if (mods.fan === false) m.push("Lüfter-PWM Fehler");
            if (mods.rtc === false) m.push("RTC (DS3231) nicht erreichbar");
            if (mods.tof === false) m.push("ToF-Sensor nicht erreichbar");
            if (mods.i2c0 === false) m.push("I²C-Bus 0 Fehler");
            if (mods.i2c1 === false) m.push("I²C-Bus 1 Fehler");
            if (mods.fs === false) m.push("Dateisystem (LittleFS) Fehler");
            const paused = h.control_paused === true;
            const head = paused ? "Regelung pausiert – Fehler erkannt:" : "Fehler erkannt:";
            const msg = (h.message && h.message.length) ? ("<div>" + h.message + "</div>") : "";
            const list = m.length ? ('<ul class="health-list"><li>' + m.join("</li><li>") + "</li></ul>") : "";
            hb.innerHTML = "<strong>" + head + "</strong>" + msg + list;
          } else { hb.innerHTML = ""; }
        } catch (_) {}
        if (s.ap && s.ap.ssid && s.ap.ip) { $("apInfo").textContent = "AP: " + s.ap.ssid + " @ " + s.ap.ip; }
      }

      async function loadInfo() {
        try {
          const r = await fetch("/api/info"); if (!r.ok) return; const j = await r.json();
          if (j && j.notify) {
            $("notifyEnabled").checked = !!j.notify.enabled;
            $("notifyPhone").value = j.notify.phone || "";
            $("notifyKey").value = j.notify.apikey || "";
            $("notifyBlock").classList.toggle("hidden", !$("notifyEnabled").checked);
          }
          const w = (j && j.wifi) || {};
          $("ssid").value = w.ssid || ""; $("pass").value = ""; $("useStatic").checked = !!w.use_static;
          const st = w.static || {}; $("ip").value = st.ip || ""; $("mask").value = st.mask || ""; $("gw").value = st.gw || ""; $("dns").value = st.dns || "";
          $("staticBlock").classList.toggle("hidden", !$("useStatic").checked);
        } catch (_) {}
      }

      async function fetchJSON(url, options) {
        const r = await fetch(url, Object.assign({ headers: { "Content-Type": "application/json" } }, options || {}));
        if (!r.ok) throw new Error(r.status + " " + r.statusText);
        return await r.json().catch(() => ({}));
      }
      function startWS() {
        try {
          const proto = location.protocol === "https:" ? "wss" : "ws";
          live.ws = new WebSocket(proto + "://" + location.host + "/ws");
          live.ws.addEventListener("message", (ev) => { try { updateStatus(JSON.parse(ev.data)); } catch (_) {} });
          live.ws.addEventListener("close", () => { startPolling(); });
          live.ws.addEventListener("error", () => { try { live.ws.close(); } catch (_) {} });
        } catch (_) { startPolling(); }
      }
      function startPolling() {
        if (live.timer) return;
        live.timer = setInterval(async () => { try { const s = await fetchJSON("/api/status"); updateStatus(s); } catch (_) {} }, 3000);
      }

      // Grow start/stop
      document.getElementById("toggleGrow").addEventListener("click", async () => {
        const started = !!(live.lastStatus && live.lastStatus.grow && live.lastStatus.grow.started);
        const action = started ? "stop" : "start";
        const tdEl = document.getElementById("totalDays");
        const total_days = tdEl ? parseInt(tdEl.textContent, 10) : undefined;
        const body = action === "start" && Number.isFinite(total_days) ? { action, total_days } : { action };
        try { await fetch("/api/grow", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) }); } catch (_) {}
      });

      // Trocknung start/stop
      document.getElementById("toggleDry").addEventListener("click", async () => {
        const active = !!(live.lastStatus && live.lastStatus.drying && live.lastStatus.drying.active);
        const action = active ? "stop" : "start";
        try { await fetch("/api/drying", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action }) }); } catch (_) {}
      });

      async function saveNotify() {
        const enabled = $("notifyEnabled").checked; const phone = $("notifyPhone").value.trim(); const rawKey = $("notifyKey").value.trim();
        const hasSavedKey = !!(live.lastStatus && live.lastStatus.notify && live.lastStatus.notify.apikey === "***");
        const apikeySend = (rawKey === "" || rawKey === "***" || rawKey === "*******") ? null : rawKey;
        if (enabled) {
          if (!phoneOk(phone)) { showToast("Telefonnummer ist ungültig (Format +49...)"); return; }
          if (!apikeySend && !hasSavedKey) { showToast("API-Key fehlt"); return; }
        }
        const payload = { enabled, phone }; if (apikeySend) payload.apikey = apikeySend;
        try { await fetchJSON("/api/notify", { method: "POST", body: JSON.stringify(payload) }); showToast("Benachrichtigung gespeichert"); }
        catch (e) {
          try { await fetchJSON("/api/network", { method: "POST", body: JSON.stringify({ notify: payload }) }); showToast("Benachrichtigung gespeichert"); }
          catch (e2) { showToast("Fehler beim Speichern: " + e2.message); }
        }
      }
      $("btnNotifySave").addEventListener("click", saveNotify);
      btnNotifyTest.addEventListener("click", async () => {
        const en = notifyEnabled.checked; const phone = notifyPhone.value.trim(); const key = notifyKey.value.trim(); const masked = key === "" || key === "***" || key === "*******";
        try { fetch(location.origin + "/api/debug/touch?stage=clicked&en=" + (en ? 1 : 0) + "&phoneLen=" + phone.length + "&key=" + (masked ? 0 : 1)).catch(() => {}); } catch (_) {}
        if (!en) { showToast("Benachrichtigungen sind deaktiviert"); return; }
        if (!phoneOk(phone)) { try { fetch(location.origin + "/api/debug/touch?stage=blocked_phone").catch(() => {}); } catch (_) {} showToast("Telefonnummer ist ungültig (Format +49...)"); return; }
        if (!masked && !key) { try { fetch(location.origin + "/api/debug/touch?stage=blocked_key").catch(() => {}); } catch (_) {} showToast("API-Key fehlt"); return; }
        try {
          showToast("Sende Testnachricht...");
          try { fetch(location.origin + "/api/debug/touch?stage=sendreq").catch(() => {}); } catch (__) {}
          const body = masked ? { phone } : { phone, apikey: key };
          const r = await fetch(location.origin + "/api/notify/test", { method: "POST", headers: { "Content-Type": "application/json", "Cache-Control": "no-cache" }, cache: "no-store", body: JSON.stringify(body) });
          if (!r.ok) { const t = await r.text().catch(() => ""); try { fetch(location.origin + "/api/debug/touch?stage=resp_err").catch(() => {}); } catch (__) {} throw new Error(r.status + " " + r.statusText + " " + t); }
          try { fetch(location.origin + "/api/debug/touch?stage=resp_ok").catch(() => {}); } catch (__) {}
          showToast("Testnachricht gesendet (siehe WhatsApp)");
        } catch (e) { showToast("Fehler beim Senden: " + e.message); }
      });
      $("btnNetSave").addEventListener("click", async () => {
        const ssid = $("ssid").value.trim(); const pass = $("pass").value; const useStatic = $("useStatic").checked;
        const ip = $("ip").value.trim(); const mask = $("mask").value.trim(); const gw = $("gw").value.trim(); const dns = $("dns").value.trim();
        const wantsStaticBlock = useStatic || ip || mask || gw || dns;
        if (!ssid && !wantsStaticBlock) { showToast("Keine WLAN-Änderungen erkannt"); return; }
        if (useStatic) {
          for (const [val, label] of [[ip, "IP-Adresse"], [mask, "Subnetzmaske"], [gw, "Gateway"]]) {
            if (!ipv4ok(val)) { showToast("Ungültige IPv4 in " + label); return; }
          }
          if (dns && !ipv4ok(dns)) { showToast("Ungültige IPv4 in DNS"); return; }
        }
        const payload = {}; if (ssid) payload.ssid = ssid; if (pass) payload.pass = pass; payload.use_static = !!useStatic; payload.static = useStatic ? { ip, mask, gw, dns } : null; payload.reboot = true;
        showToastHtml('WLAN gespeichert. Bitte jetzt ins Heimnetz wechseln und <a href="http://luminagrowx.local/" target="_blank">http://luminagrowx.local/</a> aufrufen.');
        try { fetch("/api/network", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }); } catch (_) {}
      });
      // Icons initialisieren
      function initIcons() {
        const iconGrowbox = $("iconGrowbox"); if (iconGrowbox) iconGrowbox.innerHTML = icons.plant;
        const iconAussen = $("iconAussen"); if (iconAussen) iconAussen.innerHTML = icons.home;
        const iconUptime = $("iconUptime"); if (iconUptime) iconUptime.innerHTML = icons.clock;
        const iconIp = $("iconIp"); if (iconIp) iconIp.innerHTML = icons.network;
        const iconRssi = $("iconRssi"); if (iconRssi) iconRssi.innerHTML = icons.signal;
      }
      initIcons();
      (async function () { await loadInfo(); startWS(); try { const s = await fetchJSON("/api/status"); updateStatus(s); } catch (_) {} })();
    </script>
  </body>
</html>