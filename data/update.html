<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LuminaGrowX – Update</title>
    <link rel="stylesheet" href="/pico.min.css" />
    <style>
      :root{
        --accent:#ef4444;--border:rgba(255,255,255,0.18);--text:#e5e7eb;--text-dim:#cbd5e1;
        --glass:rgba(20,20,22,0.42);--glass-strong:rgba(20,20,22,0.62);
        --radius:18px;--pico-background-color:transparent;--pico-card-background-color:transparent
      }
      html,body{height:100%}
      body{position:relative;color:var(--text);background:transparent}
      body::before{content:"";position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.55),rgba(0,0,0,0.55)),url('/bg.jpg') center/cover no-repeat #0b0b0c;z-index:-1}
      article{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);backdrop-filter:blur(3px)}
      article>header{background:var(--glass-strong);border-bottom:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0;padding:.75rem 1rem}
      button,[role=button],.button{border-radius:var(--radius)!important}
      pre{white-space:pre-wrap;background:rgba(255,255,255,0.03);border:1px solid var(--border);padding:.75rem;border-radius:12px}
      small.dim{color:var(--text-dim)}
      .btn-grid{display:grid;gap:.6rem;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    </style>
  </head>
  <body>
    <main class="container" style="margin-top:1rem">
      <article>
        <header><h2>Update</h2></header>
        <div class="content" style="padding:1rem">
          <p class="dim">Aktuelle Version: <b id="ver">-</b></p>
          <div class="btn-grid">
            <button id="btnCheck">Auf Updates prüfen</button>
            <button id="btnRunRemote" class="primary" disabled>Jetzt updaten (Internet)</button>
          </div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:.5rem; margin-top:.5rem;">
            <div>Neueste Version: <b id="latest">-</b></div>
            <div>Update verfügbar: <b id="updflag">-</b></div>
          </div>
          <pre id="log" style="margin-top:.5rem"></pre>
          <hr />
          <h3>Manuelles Paket (.tar) hochladen</h3>
          <form id="f">
            <input type="file" id="pkg" accept=".tar" />
            <button class="primary">Upload & Anwenden</button>
          </form>
          <p class="dim" style="margin-top:.5rem">Firmware im Paket ist optional. Web‑Assets unter <code>www/</code> werden selektiv aktualisiert. Konfiguration bleibt erhalten.</p>
        </div>
      </article>
    </main>

    <script>
      const ver = document.getElementById('ver');
      const log = document.getElementById('log');
      const btnC = document.getElementById('btnCheck');
      const btnR = document.getElementById('btnRunRemote');
      const latest = document.getElementById('latest');
      const updflag = document.getElementById('updflag');
      function add(m){ log.textContent += m + "\n"; }

      fetch('/api/status').then(r=>r.json()).then(j=>{ ver.textContent = j.fw || '-'; });

      btnC.onclick = () => {
        add('Neueste Version wird ermittelt...');
        fetch('/api/update/check').then(r=>r.json()).then(j=>{
          latest.textContent = j.latest || '-';
          updflag.textContent = j.hasUpdate ? 'Ja' : 'Nein';
          btnR.disabled = !j.hasUpdate || !j.tar_url;
          add('Neueste Version: ' + (j.latest||'-') + ', Update verfügbar: ' + (j.hasUpdate?'Ja':'Nein'));
        }).catch(e=> add('Fehler beim Prüfen: ' + e));
      };

      btnR.onclick = () => {
        btnR.disabled = true;
        add('Starte Remote-Update...');
        fetch('/api/update/remote', { method: 'POST' })
          .then(r=>r.json()).then(j=>{
            add(JSON.stringify(j));
            if (j.rebooting) add('Reboot...');
          }).catch(e=> add('Fehler beim Update: ' + e));
      };

      document.getElementById('f').onsubmit = (e) => {
        e.preventDefault();
        const f = document.getElementById('pkg').files[0];
        if (!f) { alert('Bitte .tar wählen'); return; }
        const fd = new FormData(); fd.append('package', f);
        add('Lade hoch...');
        fetch('/api/update/upload', { method:'POST', body: fd })
          .then(r=>r.json()).then(j=>{
            add(JSON.stringify(j));
            if (j.rebooting) add('Reboot...');
          }).catch(e=> add('Fehler beim Upload: ' + e));
      };
    </script>
  </body>
  </html>

