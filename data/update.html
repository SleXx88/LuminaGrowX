<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lisa Pro – Update</title>
    <link rel="stylesheet" href="/pico.min.css" />
    <style>
      :root {
        --accent: #ef4444;
        --accent-2: #dc2626;
        --glass: rgba(20, 20, 22, 0.42);
        --glass-strong: rgba(20, 20, 22, 0.62);
        --muted: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.18);
        --text: #e5e7eb;
        --text-dim: #cbd5e1;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --radius: 18px;
        --pico-background-color: transparent;
        --pico-card-background-color: transparent;
      }
      html, body { height: 100%; }
      body {
        position: relative;
        color: var(--text);
        background: transparent;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: #0b0b0c;
        z-index: -1;
      }
      article {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        backdrop-filter: blur(3px);
        margin-bottom: 1rem;
      }
      article > header {
        background: var(--glass-strong);
        border-bottom: 1px solid var(--border);
        border-radius: var(--radius) var(--radius) 0 0;
        padding: 0.75rem 1rem;
      }
      h2, h3 { color: var(--text); margin: 0; }
      .dim { color: var(--text-dim); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      
      button, [role="button"], .button {
        border-radius: var(--radius) !important;
        font-weight: 700;
        background: rgba(20, 20, 22, 0.42);
        color: var(--text);
        border: 1px solid var(--border);
      }
      button:hover { background: rgba(255, 255, 255, 0.06); }
      button.primary, .primary {
        background: var(--accent) !important;
        color: #fff !important;
        border-color: var(--accent) !important;
      }
      
      pre {
        white-space: pre-wrap;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        padding: 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        color: var(--text-dim);
      }
      pre#log { max-height: 200px; overflow: auto; margin-top: 0.5rem; }
      
      .progress-container { margin-top: 1rem; }
      progress { height: 12px; border-radius: 999px; }

      .changelog-box {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.75rem;
        font-size: 0.85rem;
        max-height: 300px;
        overflow: auto;
        margin-top: 0.5rem;
        white-space: pre-wrap;
      }

      details {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.5rem 1rem;
        margin-top: 0.5rem;
      }
      details summary { font-weight: 600; cursor: pointer; }

      .badge {
        display: inline-flex; align-items: center; gap: 0.4rem;
        font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 999px;
        background: var(--glass-strong); border: 1px solid var(--border);
      }
      .badge.new { background: var(--accent); color: #fff; border-color: var(--accent); }

      @media (min-width: 1024px) {
        main.container { max-width: 800px !important; margin: 2rem auto !important; }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <article>
        <header style="display: flex; justify-content: space-between; align-items: center;">
          <h2 style="display: flex; align-items: center; gap: 0.5rem;">
            <svg style="width:24px;height:24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/></svg>
            Firmware Update
          </h2>
          <span class="badge" id="currentVerBadge">V-</span>
        </header>
        <div class="content" style="padding: 1rem;">
          
          <div style="display: grid; gap: 1rem;">
            <!-- Remote Check Section -->
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
              <button id="btnCheck" style="flex: 1; min-width: 180px;">Auf Updates prüfen</button>
              <button id="btnRunRemote" class="primary" style="flex: 1; min-width: 180px; display:none;">Jetzt online updaten</button>
            </div>

            <!-- Update Info (Hidden by default) -->
            <div id="updateInfo" style="display:none; padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid var(--ok); border-radius: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Update verfügbar!</strong>
                <span class="badge new" id="latestVerBadge">V-</span>
              </div>
              <details id="detNewChangelog" style="margin-top: 0.75rem;">
                <summary>Was ist neu?</summary>
                <div id="newChangelogText" class="changelog-box">Lade...</div>
              </details>
            </div>

            <!-- Current Version Info -->
            <details id="detCurrentInfo">
              <summary>Installierte Version Details</summary>
              <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                <div class="dim">Build: <span id="buildTime" class="mono">-</span></div>
                <div style="margin-top: 0.5rem;"><strong>Changelog dieser Version:</strong></div>
                <div id="currentChangelogText" class="changelog-box">Lade lokales Changelog...</div>
              </div>
            </details>

            <hr />

            <!-- Progress & Log -->
            <div id="progressArea" style="display:none;" class="progress-container">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <small id="phaseLabel" class="dim">Bereit</small>
                <small id="progText" class="mono">-</small>
              </div>
              <progress id="prog" max="100" value="0"></progress>
              <pre id="log"></pre>
            </div>

            <!-- Manual Upload -->
            <details>
              <summary>Manuelles Paket (.tar) hochladen</summary>
              <div style="margin-top: 1rem;">
                <form id="f">
                  <input type="file" id="pkg" accept=".tar" />
                  <button type="submit" class="primary" style="width: 100%;">Upload & Anwenden</button>
                </form>
              </div>
            </details>
          </div>
        </div>
        <footer style="display: flex; gap: 0.5rem; padding: 0.75rem 1rem; border-top: 1px solid var(--border);">
          <a href="/" role="button" class="outline">Zurück zum Dashboard</a>
        </footer>
      </article>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);
      const log = $('log');
      const prog = $('prog');
      const progText = $('progText');
      const phaseLabel = $('phaseLabel');
      
      let currentFwVer = null;
      let preBuild = null, expectedFw = null;

      let lastLogMsg = '';
      function addLog(m) {
        if (m === lastLogMsg) return;
        lastLogMsg = m;
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      function extractVersionNotes(text, version) {
        if (!text || !version) return text;
        // Suche nach ## [Version] bis zum nächsten ## oder Ende
        const escapedVer = version.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(## \\[${escapedVer}\\].*?)(?=\\n## |$)`, 'gs');
        const match = regex.exec(text);
        return match ? match[1].trim() : text;
      }

      async function init() {
        try {
          const r = await fetch('/api/status');
          const j = await r.json();
          currentFwVer = j.fw || 'V-';
          $('currentVerBadge').textContent = currentFwVer;
          $('buildTime').textContent = j.build || '-';
          preBuild = j.build || null;

          // If background check already found an update, show it
          if (j.update && j.update.has_update && j.update.latest) {
            $('updateInfo').style.display = 'block';
            $('btnRunRemote').style.display = 'inline-block';
            $('latestVerBadge').textContent = j.update.latest;
            $('newChangelogText').textContent = 'Prüfe Details...';
            expectedFw = j.update.latest;
            
            // Try to load changelog for the latest version
            fetch('/api/update/check').then(res => res.json()).then(cj => {
              if (cj.changelog) $('newChangelogText').textContent = cj.changelog;
              else $('newChangelogText').textContent = 'Keine Details verfügbar.';
            }).catch(() => {});
          }
          
          // Lokales Changelog laden
          fetch('/CHANGELOG.md').then(res => res.text()).then(text => {
            $('currentChangelogText').textContent = extractVersionNotes(text, currentFwVer);
          }).catch(() => {
            $('currentChangelogText').textContent = "Lokales Changelog nicht gefunden.";
          });
        } catch (e) { console.error(e); }
      }

      function phaseText(ph) {
        switch(String(ph||'')) {
          case 'uploading': return 'Hochladen...';
          case 'downloading': return 'Lade Update herunter...';
          case 'checking': return 'Prüfe Update-Quelle...';
          case 'applying': return 'Entpacken und anwenden...';
          case 'done': return 'Abgeschlossen';
          case 'error': return 'Fehler';
          default: return String(ph||'Bereit');
        }
      }

      function pollProgress() {
        fetch('/api/update/progress').then(r => r.json()).then(j => {
          $('progressArea').style.display = 'block';
          phaseLabel.textContent = phaseText(j.phase);
          
          if (j.msg) addLog(j.msg);
          
          let pct = -1, txt = '-';
          if (j.download && j.download.pct >= 0) { pct = j.download.pct; txt = `${j.download.sofar} / ${j.download.total} Bytes`; }
          if (j.apply && j.apply.pct >= 0) { pct = Math.max(pct, j.apply.pct); txt = `Anwenden: ${j.apply.pct}%`; }
          
          if (pct >= 0) { prog.value = pct; progText.textContent = txt; }
          
          if (!j.running) {
            if (j.ok) {
              addLog('Update erfolgreich abgeschlossen.');
              if (j.fwUpdated) { addLog('Gerät startet neu...'); waitForReboot(expectedFw); }
            } else if (j.error) {
              addLog('Fehler: ' + j.error);
            }
          } else {
            setTimeout(pollProgress, 500);
          }
        }).catch(() => setTimeout(pollProgress, 1000));
      }

      function waitForReboot(expectFw) {
        let attempts = 0;
        const ping = () => {
          attempts++;
          fetch('/api/status', {cache:'no-store'}).then(r => r.json()).then(j => {
            // Wenn Build anders ODER Uptime sehr klein ODER wir schon oft genug gepinnt haben und das Geraet da ist
            if (j.build !== preBuild || (j.uptime_s && j.uptime_s < 30) || attempts > 5) {
              location.href = '/';
            } else { setTimeout(ping, 2000); }
          }).catch(() => {
            // Geraet ist offline (rebootet gerade)
            setTimeout(ping, 2000);
          });
        };
        setTimeout(ping, 5000); // Warte 5s bis zum ersten Ping
      }

      $('btnCheck').onclick = async () => {
        addLog('Suche nach Updates...');
        try {
          const r = await fetch('/api/update/check');
          const j = await r.json();
          if (j.hasUpdate) {
            $('updateInfo').style.display = 'block';
            $('btnRunRemote').style.display = 'inline-block';
            $('latestVerBadge').textContent = j.latest;
            $('newChangelogText').textContent = j.changelog || 'Keine Details verfügbar.';
            expectedFw = j.latest;
            addLog(`Update auf ${j.latest} verfügbar.`);
          } else {
            addLog('Firmware ist auf dem neuesten Stand.');
            alert('Deine Firmware ist bereits aktuell.');
          }
        } catch (e) { addLog('Fehler beim Prüfen: ' + e); }
      };

      $('btnRunRemote').onclick = async () => {
        if (!confirm('Update jetzt starten? Das Gerät regelt währenddessen nicht.')) return;
        try {
          const r = await fetch('/api/update/remote', { method: 'POST' });
          if (r.status === 202) {
            $('progressArea').style.display = 'block';
            pollProgress();
          }
        } catch (e) { addLog('Fehler beim Starten: ' + e); }
      };

      $('f').onsubmit = (e) => {
        e.preventDefault();
        const f = $('pkg').files[0];
        if (!f) return;
        const fd = new FormData(); fd.append('package', f);
        addLog('Manuelles Update gestartet...');
        $('progressArea').style.display = 'block';
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/update/upload');
        xhr.upload.onprogress = (ev) => {
          if (ev.lengthComputable) {
            const pct = Math.round(ev.loaded * 100 / ev.total);
            prog.value = pct; progText.textContent = `Upload: ${pct}%`;
          }
        };
        xhr.onload = () => { if (xhr.status === 202) pollProgress(); else addLog('Upload Fehler: ' + xhr.status); };
        xhr.send(fd);
      };

      init();
    </script>
  </body>
</html>
