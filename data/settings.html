<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LuminaGrowX – Einstellungen</title>
    <link rel="stylesheet" href="/pico.min.css" />
    <style>
      :root{
        --accent:#ef4444;--border:rgba(255,255,255,0.18);--text:#e5e7eb;--text-dim:#cbd5e1;
        --glass:rgba(20,20,22,0.42);--glass-strong:rgba(20,20,22,0.62);
        --radius:18px;--pico-background-color:transparent;--pico-card-background-color:transparent
      }
      html,body{height:100%}
      body{position:relative;color:var(--text);background:transparent}
      body::before{content:"";position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.55),rgba(0,0,0,0.55)),url('/bg.jpg') center/cover no-repeat #0b0b0c;z-index:-1}
      article{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);backdrop-filter:blur(3px)}
      article>header{background:var(--glass-strong);border-bottom:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0;padding:.75rem 1rem}
      .hidden{display:none}
      input,select,button,[role=button],.button{border-radius:var(--radius)!important}
      input,select{background:rgba(255,255,255,0.02)!important;color:var(--text)!important;border:1px solid var(--border)!important}
      button,[role=button],.button{background:rgba(20,20,22,0.42);color:var(--text);border:1px solid var(--border);font-weight:700;font-size:1rem;line-height:1.2;padding:0.55rem 0.9rem;border-radius:var(--radius)!important}
      @media (min-width:768px){button,[role=button],.button{font-size:0.95rem;padding:0.5rem 0.85rem}}
      @media (min-width:1200px){button,[role=button],.button{font-size:0.9rem;padding:0.45rem 0.8rem}}
      button:hover{background:rgba(255,255,255,0.06)}
      button:active,button.primary,.primary{background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important}
      input[type=checkbox],input[type=radio]{accent-color:var(--accent)}
      input[type=checkbox]{width:1.1rem;height:1.1rem;margin-right:0.5rem;border:2px solid var(--border)!important;background:rgba(255,255,255,0.06)!important}
      label>input[type=checkbox]{vertical-align:middle}
    </style>
  </head>
  <body>
    <main class="container" style="margin-top:1rem">
      <article>
        <header>
          <h2>Einstellungen</h2>
        </header>
        <div class="content" style="padding:1rem; display:grid; gap:1rem;">
          <form id="netForm">
            <h4>WLAN</h4>
            <div class="grid">
              <label>SSID <input id="ssid" name="ssid" placeholder="MeinWiFi" /></label>
              <label>Passwort <input id="pass" name="pass" type="password" placeholder="********" /></label>
            </div>
            <div class="grid">
              <label><input type="checkbox" id="useStatic" name="useStatic" role="switch" /> Statische IP-Adresse verwenden</label>
            </div>
            <div id="staticBlock" class="grid hidden">
              <label>IP-Adresse <input id="ip" name="ip" placeholder="192.168.1.50" /></label>
              <label>Subnetzmaske <input id="mask" name="mask" placeholder="255.255.255.0" /></label>
              <label>Gateway <input id="gw" name="gw" placeholder="192.168.1.1" /></label>
              <label>DNS (optional) <input id="dns" name="dns" placeholder="1.1.1.1" /></label>
            </div>
            <footer style="display:flex; justify-content:flex-end; gap:.5rem; padding-top:.5rem;">
              <button type="button" id="btnNetSave" class="primary">Speichern</button>
            </footer>

            <hr />
            <h4>Benachrichtigungen (WhatsApp via CallMeBot)</h4>
            <label><input type="checkbox" id="notifyEnabled" role="switch" /> Benachrichtigungen aktivieren</label>
            <div id="notifyBlock" class="grid hidden">
              <label>Telefonnummer (+Ländervorwahl) <input id="notifyPhone" placeholder="+49XXXXXXXXXX" /></label>
              <label>API-Key <input id="notifyKey" placeholder="1234567" /></label>
              <div style="display:flex; gap:.5rem;">
                <button id="btnNotifySave" type="button" class="primary">Speichern</button>
                <button id="btnNotifyTest" type="button">Testnachricht senden</button>
              </div>
            </div>
          </form>
        </div>
        <footer style="display:flex; gap:.5rem; padding:.75rem 1rem; border-top:1px solid var(--border); margin-top:.5rem;">
          <a href="/" role="button">Zurück</a>
          <a href="/setup" id="btnSetup" role="button">Setup</a>
        </footer>
      </article>
    </main>

    <dialog id="toast" class="modal">
      <article>
        <header><strong>Status</strong></header>
        <div class="content" style="padding: 1rem;">
          <p id="toastMsg">-</p>
        </div>
        <footer style="display:flex; justify-content:flex-end; padding:.75rem 1rem;">
          <button onclick="document.getElementById('toast').close()">OK</button>
        </footer>
      </article>
    </dialog>

    <script>
      const $ = (id) => document.getElementById(id);
      function showToast(msg){ const p=$('toastMsg'); p.textContent = msg; $('toast').showModal(); }
      function showToastHtml(html){ const p=$('toastMsg'); p.innerHTML = html; $('toast').showModal(); }
      function ipv4ok(s){ const parts=(s||'').split('.').map(n=>+n); return parts.length===4 && parts.every(n=>Number.isInteger(n) && n>=0 && n<=255); }
      function phoneOk(s){ return /^\+\d{6,16}$/.test((s||'').trim()); }

      async function fetchJSON(url, options){ const r=await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, options||{})); if(!r.ok) throw new Error(r.status+' '+r.statusText); return await r.json().catch(()=> ({})); }

      async function loadInfo(){
        try{
          const j = await fetchJSON('/api/info');
          if (j && j.notify){
            $('notifyEnabled').checked = !!j.notify.enabled;
            $('notifyPhone').value = j.notify.phone || '';
            $('notifyKey').value = j.notify.apikey || '';
            $('notifyBlock').classList.toggle('hidden', !$('notifyEnabled').checked);
          }
          const w = (j && j.wifi) || {};
          $('ssid').value = w.ssid || '';
          $('pass').value = '';
          $('useStatic').checked = !!(w.use_static);
          const st = (w.static) || {};
          $('ip').value = st.ip || '';
          $('mask').value = st.mask || '';
          $('gw').value = st.gw || '';
          $('dns').value = st.dns || '';
          $('staticBlock').classList.toggle('hidden', !$('useStatic').checked);
        }catch(_){ }
      }

      // Setup-Button Status aktualisieren
      async function updateSetupButton(){
        try{
          const st = await fetchJSON('/api/status');
          const growActive = !!(st && st.grow && st.grow.started);
          const dryingActive = !!(st && st.drying && st.drying.active);
          const canSetup = !growActive && !dryingActive;

          const btn = $('btnSetup');
          if(canSetup){
            btn.style.pointerEvents = '';
            btn.style.opacity = '';
            btn.title = '';
          } else {
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.4';
            btn.title = 'Setup nicht verfügbar während Grow oder Trocknung aktiv ist';
          }
        }catch(_){ }
      }

      $('useStatic').addEventListener('change', (e)=> $('staticBlock').classList.toggle('hidden', !e.target.checked));
      $('notifyEnabled').addEventListener('change', (e)=> $('notifyBlock').classList.toggle('hidden', !e.target.checked));

      $('btnNetSave').addEventListener('click', async ()=>{
        const ssid=$('ssid').value.trim();
        const pass=$('pass').value;
        const useStatic=$('useStatic').checked;
        const ip=$('ip').value.trim();
        const mask=$('mask').value.trim();
        const gw=$('gw').value.trim();
        const dns=$('dns').value.trim();
        const wantsStaticBlock = useStatic || ip || mask || gw || dns;
        if(!ssid && !wantsStaticBlock){ showToast('Keine WLAN-Änderungen erkannt'); return; }
        if(useStatic){
          for(const [val,label] of [[ip,'IP-Adresse'],[mask,'Subnetzmaske'],[gw,'Gateway']]){
            if(!ipv4ok(val)){ showToast('Ungültige IPv4 in '+label); return; }
          }
          if(dns && !ipv4ok(dns)){ showToast('Ungültige IPv4 in DNS'); return; }
        }
        const payload = {};
        if(ssid) payload.ssid = ssid;
        if(pass) payload.pass = pass;
        payload.use_static = !!useStatic;
        payload.static = useStatic ? { ip, mask, gw, dns } : null;
        payload.reboot = true;
        // Genau wie vorher: Hinweis anzeigen und Request feuern, ohne auf Antwort zu warten (Reboot kann Verbindung trennen)
        showToastHtml('WLAN gespeichert. Bitte jetzt ins Heimnetz wechseln und <a href="http://luminagrowx.local/" target="_blank">http://luminagrowx.local/</a> aufrufen.');
        try{ fetch('/api/network', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); }catch(_){ }
      });

      $('btnNotifySave').addEventListener('click', async ()=>{
        const enabled = $('notifyEnabled').checked;
        const phone = $('notifyPhone').value.trim();
        const rawKey = $('notifyKey').value.trim();
        const apikeySend = (rawKey === '' || rawKey === '***' || rawKey === '*******') ? null : rawKey;
        if (enabled) {
          if (!phoneOk(phone)) { showToast('Telefonnummer ist ungültig (Format +49...)'); return; }
          if (!apikeySend) { showToast('API-Key fehlt'); return; }
        }
        const payload = { enabled, phone };
        if (apikeySend) payload.apikey = apikeySend;
        try{ await fetchJSON('/api/notify', { method:'POST', body: JSON.stringify(payload) }); showToast('Benachrichtigung gespeichert'); }
        catch(e){ showToast('Fehler beim Speichern: '+e.message); }
      });

      $('btnNotifyTest').addEventListener('click', async ()=>{
        const en=$('notifyEnabled').checked; const phone=$('notifyPhone').value.trim(); const key=$('notifyKey').value.trim(); const masked=(key===''||key==='***'||key==='*******');
        if(!en){ showToast('Benachrichtigungen sind deaktiviert'); return; }
        if(!phoneOk(phone)){ showToast('Telefonnummer ist ungültig (Format +49...)'); return; }
        if(!masked && !key){ showToast('API-Key fehlt'); return; }
        const body = masked ? { phone } : { phone, apikey: key };
        try{ const r=await fetch('/api/notify/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); showToast('Testnachricht gesendet'); }
        catch(e){ showToast('Fehler beim Senden: '+e.message); }
      });

      // Setup-Button mit Bestätigungsdialog
      $('btnSetup').addEventListener('click', async (e)=>{
        e.preventDefault();
        const confirmed = confirm('WARNUNG: Der Setup-Modus löscht alle Einstellungen und startet das Gerät neu.\n\nMöchten Sie fortfahren?');
        if (!confirmed) return;

        try{
          const r = await fetch('/api/setup/reset', {method:'POST'});
          if (r.ok) {
            showToast('Setup wird zurückgesetzt. Gerät startet neu...');
            setTimeout(()=> window.location.href = '/setup', 3000);
          } else {
            showToast('Fehler beim Zurücksetzen: ' + r.statusText);
          }
        } catch(e) {
          showToast('Fehler: ' + e.message);
        }
      });

      loadInfo();
      updateSetupButton();
    </script>
  </body>
  </html>